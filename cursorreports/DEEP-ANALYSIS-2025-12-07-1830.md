# DEEP CODEBASE ANALYSIS REPORT
**Generated:** 2025-12-07 18:30 UTC  
**Project:** aimoviez-app  
**Scope:** Full-stack security, performance, logic, and architecture review

---

## Executive Summary

This Next.js/Supabase application shows **solid security foundations** with proper authentication, CSRF protection, input validation via Zod, and rate limiting infrastructure. However, several **critical and high-severity issues** need attention.

**Risk Level:** MEDIUM-HIGH  
**Critical Issues:** 5  
**High Severity:** 9  
**Medium Severity:** 12  
**Low Severity:** 8  
**Total Issues:** 34

---

## CRITICAL ISSUES (Immediate Action Required)

### 1. Upload Endpoint - No Rate Limiting (CRITICAL)

**File:** `src/app/api/upload/route.ts`

The main upload POST endpoint lacks rate limiting wrapper. No `rateLimit(request, 'upload')` call at the start of the handler.

- **Risk:** Attackers can flood uploads, exhaust storage quota, cause memory pressure (50MB files loaded into memory)
- **Impact:** DoS, storage costs, server instability
- **Fix:** Add `const rateLimitResponse = await rateLimit(request, 'upload'); if (rateLimitResponse) return rateLimitResponse;` at start of POST handler

---

### 2. Account Deletion - Wrong Table Reference (CRITICAL)

**File:** `src/app/api/account/delete/route.ts`

```javascript
// Line 46-51 - Queries wrong table
const { data: profile } = await supabase
  .from('profiles')  // BUG: Should be 'users'
  .select('id')
  .eq('email', userEmail)
  .single();
```

- **Risk:** Account deletion silently fails, user data remains, GDPR compliance breach
- **Impact:** Legal liability, data retention violations
- **Fix:** Change `'profiles'` to `'users'` in all queries in this file

---

### 3. Auto-Advance Cron - No Transaction Safety (CRITICAL)

**File:** `src/app/api/cron/auto-advance/route.ts`

Multiple sequential database operations without transaction wrapper:
1. Lock current slot
2. Update winning clip status
3. Move losing clips to next slot
4. Activate next slot

- **Risk:** Partial failures leave database in inconsistent state (slot locked but clips not moved, or clips moved but next slot not activated)
- **Impact:** Tournament corruption, data inconsistency
- **Fix:** Wrap in Supabase RPC function with PostgreSQL transaction, or use database triggers

---

### 4. Report Endpoint - Missing Rate Limiting (CRITICAL)

**File:** `src/app/api/report/route.ts`

No rate limiting on report submission despite using service role key.

- **Risk:** Spam/abuse vector for mass false reports against users/clips
- **Impact:** Admin overwhelm, false positives, harassment vector
- **Fix:** Add `const rateLimitResponse = await rateLimit(request, 'contact'); if (rateLimitResponse) return rateLimitResponse;`

---

### 5. Comments - Anonymous User Ownership Spoofable (CRITICAL)

**File:** `src/app/api/comments/route.ts`

```javascript
// Lines 66-70
const userKey = userId ? `user_${userId}` : deviceKey;
// deviceKey is derived from IP + UserAgent - easily spoofable
```

For anonymous users, `user_key` is derived from IP+UserAgent hash which can be spoofed. While DELETE requires authentication, the `is_own` flag display relies on this spoofable key.

- **Risk:** Users could potentially claim ownership of others' anonymous comments
- **Fix:** Require authentication for all comment operations, or add additional verification

---

## HIGH SEVERITY ISSUES

### 6. CSP Allows unsafe-inline Scripts

**File:** `next.config.ts` (lines 30-32)

```javascript
process.env.NODE_ENV === 'development'
  ? "script-src 'self' 'unsafe-inline' 'unsafe-eval'"
  : "script-src 'self' 'unsafe-inline'"  // Production still allows unsafe-inline
```

- **Risk:** XSS vulnerabilities more exploitable if found
- **Recommendation:** Use nonces or strict-dynamic CSP with proper Next.js integration

---

### 7. Service Role Key Overuse

Multiple API routes use service role key when anon client would suffice:
- `src/app/api/contact/route.ts` - Could use anon for inserts with RLS
- `src/app/api/vote/route.ts` - GET endpoint reads public data
- `src/app/api/comments/route.ts` - GET reads public comments

- **Risk:** Bypasses RLS policies unnecessarily, larger attack surface if key leaked
- **Fix:** Use `getAnonClient()` from `lib/supabase-client.ts` for read operations

---

### 8. Vote Integrity Token Not Enforced

**File:** `src/lib/device-fingerprint.ts`

Functions `generateVoteIntegrityToken()` and `verifyVoteIntegrityToken()` exist but are **never called** in the vote POST handler.

- **Risk:** Vote manipulation through replay attacks
- **Fix:** Require and verify integrity token on each vote submission

---

### 9. Admin Actions Lack Rate Limiting

Admin endpoints without rate limiting:
- `src/app/api/admin/approve/route.ts`
- `src/app/api/admin/reject/route.ts`
- `src/app/api/admin/bulk/route.ts`
- `src/app/api/admin/reset-season/route.ts`
- `src/app/api/admin/advance-slot/route.ts`

- **Risk:** Compromised admin account could cause rapid, large-scale damage
- **Fix:** Add rate limiting with 'admin' tier (50 req/min configured in rate-limit.ts)

---

### 10. Signed URL Generator - No Per-User Quotas

**File:** `src/app/api/upload/signed-url/route.ts`

Rate limited to 5/minute but no daily/weekly quota per user.

- **Risk:** Determined attacker can generate 7,200 signed URLs per day
- **Fix:** Add daily upload quota tracking in database

---

### 11. Multi-Vote Flag Security

**File:** `src/app/api/vote/route.ts` (lines 1148-1183)

When `multi_vote_mode` is enabled, existing votes are updated to add weight without proper audit trail.

- **Risk:** Vote inflation if flag accidentally enabled
- **Fix:** Add comprehensive logging and require admin confirmation

---

### 12. CAPTCHA Not Required by Default

**File:** `src/app/api/vote/route.ts`

```javascript
const captchaRequired = captchaFlag?.enabled ?? false;  // Defaults to OFF
```

- **Risk:** Bot voting possible without CAPTCHA
- **Recommendation:** Default to true for production

---

### 13. Auth Required Flag Not Enforced

**File:** `src/app/api/vote/route.ts`

```javascript
const requireAuth = authRequiredFlag?.enabled ?? false;  // Defaults to OFF
```

- **Risk:** Anonymous voting allows easier vote manipulation
- **Recommendation:** Consider enabling by default

---

### 14. Session Timeout Logic Gap

**File:** `src/middleware.ts` (lines 270-288)

Session timeout only checked on protected routes, not on API calls to those routes.

- **Risk:** Stale sessions could make API calls after timeout
- **Fix:** Apply timeout check to API routes as well

---

## MEDIUM SEVERITY ISSUES

### 15. localStorage Stores User Profile

**File:** `src/hooks/useAuth.tsx`

```javascript
localStorage.setItem('user_profile', JSON.stringify(data.user));
```

- **Risk:** Data persists after logout, accessible to XSS
- **Fix:** Clear on logout, consider sessionStorage

---

### 16. Contact Form - Weak Sanitization

**File:** `src/app/api/contact/route.ts`

Uses custom inline sanitizer instead of comprehensive `sanitize.ts` module.

```javascript
function sanitizeInput(input: string): string {
  return input
    .replace(/[<>]/g, '')
    .replace(/javascript:/gi, '')
    .replace(/on\w+=/gi, '')
    .trim();
}
```

- **Fix:** Use `sanitizeText()` from `lib/sanitize.ts`

---

### 17. Feature Flags Queried Per-Request

**File:** `src/app/api/vote/route.ts`

Feature flags queried from database on every vote (3 queries per POST).

- **Impact:** Performance overhead, database load
- **Fix:** Cache flags in memory with TTL (similar to season/slot caching)

---

### 18. RLS Policies Too Permissive

**File:** `supabase/sql/enable-rls-policies.sql`

```sql
CREATE POLICY "votes_insert_authenticated" ON votes
  FOR INSERT
  WITH CHECK (true);  -- Allows ALL inserts
```

- **Risk:** RLS provides no protection, relies entirely on API validation
- **Fix:** Add proper user validation in RLS policies

---

### 19. No Audit Log for Failed Auth

Authentication failures logged to console but not to `audit_logs` table.

- **Fix:** Add failed login tracking for security monitoring

---

### 20. Referral Code Stored in localStorage

**File:** `src/app/join/[code]/page.tsx`

```javascript
localStorage.setItem('referral_code', referralCode.toUpperCase());
```

- **Risk:** Referral attribution manipulation
- **Fix:** Use server-side session or signed cookie

---

### 21. Missing Request ID Correlation

API responses include `requestId` but it's not propagated through logs.

- **Fix:** Pass requestId to logger for correlation

---

### 22. Error Details Leak in Development

**File:** `src/lib/api-utils.ts`

```javascript
...(process.env.NODE_ENV === 'development' && errorDetails ? { details: errorDetails } : {}),
```

- **Risk:** Could leak if NODE_ENV misconfigured
- **Fix:** Use explicit SHOW_ERROR_DETAILS env var

---

### 23. Pusher Broadcast Errors Silently Ignored

**File:** `src/app/api/vote/route.ts`

```javascript
broadcastVoteUpdate(clipId, newVoteCount).catch(() => {
  // Silently ignore broadcast errors
});
```

- **Fix:** Log broadcast failures for monitoring

---

### 24. Device Key Migration Risk

Old votes use legacy device key format, new votes use enhanced fingerprint. No migration path.

- **Risk:** Users could lose vote history association
- **Fix:** Document migration strategy

---

### 25. File Size Validation After Memory Load

**File:** `src/app/api/upload/route.ts`

File is validated for size AFTER `formData.get('video')` which already loads it.

- **Risk:** Memory pressure from oversized files before rejection
- **Fix:** Use streaming validation or check Content-Length header first

---

### 26. Missing Indexes on Frequent Queries

Several queries filter on columns that may lack indexes:
- `votes.voter_key` + `votes.clip_id` (checked - has unique constraint)
- `tournament_clips.season_id` + `tournament_clips.slot_position`

- **Fix:** Verify indexes exist in database

---

## LOW SEVERITY ISSUES

### 27. Missing Response Caching Headers

Read-only API endpoints don't set `Cache-Control` headers.

- **Fix:** Add `Cache-Control: public, max-age=30` for leaderboards, etc.

---

### 28. Hardcoded Fallback Secrets

**File:** `src/lib/device-fingerprint.ts`

```javascript
secret: string = process.env.VOTE_INTEGRITY_SECRET || 'default-secret'
```

- **Fix:** Throw error in production if not set

---

### 29. Console Logs in Production

Multiple files use `console.log/error` - should use structured logger with levels.

---

### 30. Missing Error Boundaries

Some page components lack error boundaries for graceful degradation.

---

### 31. Test Coverage Gaps

Only 5 test files found:
- `src/__tests__/components/` - 3 files
- `src/__tests__/hooks/useCsrf.test.tsx`
- `src/__tests__/lib/` - 5 files

Critical paths like vote submission and upload lack tests.

---

### 32. TypeScript Strict Mode Not Enabled

`tsconfig.json` uses default strict settings - could be stricter.

---

### 33. No Health Check Authentication

**File:** `src/app/api/health/route.ts`

Health endpoint publicly accessible (by design, but exposes system info).

---

### 34. Deprecated Node Warning Suppression

**File:** `package.json`

```json
"dev": "NODE_OPTIONS='--no-warnings=DEP0169' next dev"
```

- **Fix:** Address underlying deprecation instead of suppressing

---

## POSITIVE FINDINGS

1. **CSRF Protection** - Well-implemented double-submit cookie pattern with HMAC signatures in middleware
2. **Input Validation** - Comprehensive Zod schemas for all major endpoints (`lib/validations.ts`)
3. **Sanitization Library** - Robust `sanitize.ts` module with XSS prevention
4. **Rate Limiting Infrastructure** - Upstash Redis with configurable tiers and in-memory fallback
5. **Audit Logging** - Admin actions logged to database with user tracking
6. **Device Fingerprinting** - Multi-signal fraud detection with risk scoring
7. **File Upload Security** - Magic byte verification, polyglot detection, MIME validation
8. **Session Security** - 24-hour JWT expiry, secure httpOnly cookies, SameSite strict
9. **Admin Auth** - Database-backed admin verification (not just session flag)
10. **Vote Race Conditions** - Atomic RPC function for vote deletion exists

---

## PRIORITY FIX LIST

| Priority | Issue | File | Effort | Impact |
|----------|-------|------|--------|--------|
| P0 | Add rate limiting to upload | `api/upload/route.ts` | Low | DoS prevention |
| P0 | Fix account deletion table | `api/account/delete/route.ts` | Low | GDPR compliance |
| P0 | Transaction safety in auto-advance | `api/cron/auto-advance/route.ts` | Medium | Data integrity |
| P0 | Add rate limiting to report | `api/report/route.ts` | Low | Abuse prevention |
| P1 | Use anon client for reads | Multiple files | Medium | Security posture |
| P1 | Rate limit admin endpoints | `api/admin/*` | Low | Damage control |
| P1 | Enforce vote integrity tokens | `api/vote/route.ts` | Medium | Vote security |
| P2 | Cache feature flags | `api/vote/route.ts` | Low | Performance |
| P2 | Use sanitize.ts in contact | `api/contact/route.ts` | Low | Consistency |
| P2 | Remove unsafe-inline from CSP | `next.config.ts` | Medium | XSS protection |
| P3 | Add response caching headers | Multiple | Low | Performance |
| P3 | Improve test coverage | `__tests__/` | High | Reliability |

---

## RECOMMENDATIONS

### Immediate (This Week)
1. Fix P0 issues - all are low effort, high impact
2. Enable `require_auth_voting` feature flag
3. Run database migration to add missing indexes

### Short Term (This Month)
1. Implement vote integrity token verification
2. Convert auto-advance to RPC transaction
3. Add rate limiting to all admin endpoints
4. Audit and fix service role key usage

### Long Term
1. Implement strict CSP with nonces
2. Add comprehensive test coverage
3. Consider Supabase Auth for true RLS
4. Implement IP reputation checking

---

*Report generated by Cursor AI*  
*Analysis scope: 55 API routes, 22 lib modules, 20+ components*
