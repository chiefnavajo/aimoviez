
> aimoviez-app@0.1.0 test:integration
> jest --config jest.integration.config.js

  console.log
    Integration tests starting...

      at Object.<anonymous> (jest.integration.setup.ts:30:11)

  console.log
    Supabase URL: http://localhost:54321

      at Object.<anonymous> (jest.integration.setup.ts:31:11)

  console.log
    Integration tests complete.

      at Object.<anonymous> (jest.integration.setup.ts:35:11)

PASS integration src/__tests__/integration/admin/operation-combinations.test.ts
  Operation Combinations
    Upload Combinations
      ✓ upload → delete (never approved) (46 ms)
      ✓ upload → approve → delete (40 ms)
      ✓ upload → reject → delete (22 ms)
      ✓ upload → approve → reject → reapprove (26 ms)
    Winner Combinations
      ✓ approve → winner → unlock → delete (31 ms)
      ✓ approve → winner → unlock → re-approve → winner again (26 ms)
      ✓ two clips → winner clip1 → unlock → winner clip2 (32 ms)
    Edit Combinations
      ✓ upload → edit title → approve (19 ms)
      ✓ approve → edit → still active (15 ms)
      ✓ locked clip cannot be edited (guard check) (12 ms)
    Slot Status Combinations
      ✓ waiting_for_clips → voting → waiting_for_clips (all deleted) (15 ms)
      ✓ voting → locked → voting (unlock) (36 ms)
      ✓ slot 1 locked → slot 2 becomes waiting_for_clips (32 ms)
    Bulk Operation Combinations
      ✓ bulk approve multiple clips (31 ms)
      ✓ bulk delete all → slot resets (36 ms)
      ✓ bulk reject does not affect other clips (29 ms)
    Edge Case Combinations
      ✓ delete winner → blocked, unlock → delete → success (28 ms)
      ✓ multiple operations on same clip rapid succession (27 ms)
      ✓ all clips rejected → slot stays waiting (no active clips) (27 ms)
      ✓ mixed statuses in slot: active + pending + rejected (25 ms)
      ✓ unlock → edit → re-lock with same clip (33 ms)
    Timer Combinations
      ✓ timer starts → all clips deleted → timer clears (24 ms)
      ✓ timer running → add more clips → timer continues (18 ms)
      ✓ timer running → winner assigned → timer preserved in lock (21 ms)

  console.log
    Integration tests starting...

      at Object.<anonymous> (jest.integration.setup.ts:30:11)

  console.log
    Supabase URL: http://localhost:54321

      at Object.<anonymous> (jest.integration.setup.ts:31:11)

  console.log
    Integration tests complete.

      at Object.<anonymous> (jest.integration.setup.ts:35:11)

PASS integration src/__tests__/integration/admin/clip-lifecycle.test.ts
  Clip Lifecycle
    Basic Clip Creation
      ✓ creates a pending clip successfully (9 ms)
      ✓ creates multiple clips with unique IDs (7 ms)
    Approve Flow
      ✓ approving a clip assigns it to the first available slot (11 ms)
      ✓ approving first clip starts the 24h timer (10 ms)
    Winner Assignment
      ✓ assigning winner locks the clip and slot (13 ms)
      ✓ assigning winner advances to next slot (13 ms)
    Unlock Flow
      ✓ unlocking a slot reverts clip status to pending (12 ms)
    Delete Flow - THE BUG WE FIXED
      ✓ deleting last clip after unlock resets slot to waiting_for_clips (25 ms)
      ✓ deleting last active clip clears timer (19 ms)
      ✓ deleting one of multiple clips does NOT reset slot (17 ms)
    Safety Checks
      ✓ cannot delete a clip that is the slot winner (8 ms)
      ✓ cannot edit a locked clip status (6 ms)

  console.log
    Integration tests starting...

      at Object.<anonymous> (jest.integration.setup.ts:30:11)

  console.log
    Supabase URL: http://localhost:54321

      at Object.<anonymous> (jest.integration.setup.ts:31:11)

  console.log
    Integration tests complete.

      at Object.<anonymous> (jest.integration.setup.ts:35:11)

PASS integration src/__tests__/integration/admin/slot-management.test.ts
  Slot Management
    Timer Management
      ✓ approving first clip starts 24h timer (12 ms)
      ✓ bulk delete all clips resets slot to waiting_for_clips (38 ms)
      ✓ deleting pending clips also resets slot (21 ms)
    Status Transitions
      ✓ slot transitions: upcoming -> waiting_for_clips -> voting -> locked (29 ms)
      ✓ unlocking slot clears winner reference (21 ms)
    Edge Cases
      ✓ slot with mixed active and pending clips stays in voting (25 ms)
      ✓ rejected clips do not count towards slot status (20 ms)

  console.log
    Integration tests starting...

      at Object.<anonymous> (jest.integration.setup.ts:30:11)

  console.log
    Supabase URL: http://localhost:54321

      at Object.<anonymous> (jest.integration.setup.ts:31:11)

  console.log
    Integration tests complete.

      at Object.<anonymous> (jest.integration.setup.ts:35:11)

PASS integration src/__tests__/integration/admin/safety-checks.test.ts
  Safety Checks
    Winner Protection
      ✓ winner clip is linked to slot via winner_tournament_clip_id (9 ms)
      ✓ can detect if clip is a winner before delete (9 ms)
      ✓ non-winner clips can be deleted (10 ms)
    Locked Clip Guards
      ✓ locked clip has status = locked (6 ms)
      ✓ can detect locked clip before edit (8 ms)
      ✓ unlocked clip can be edited (8 ms)
    Unlock Before Modify
      ✓ unlocking slot clears winner and allows modification (14 ms)
      ✓ attempting to modify locked slot winner fails safety check (11 ms)
    Bulk Operation Safety
      ✓ bulk delete should skip winner clips (15 ms)

Test Suites: 4 passed, 4 total
Tests:       52 passed, 52 total
Snapshots:   0 total
Time:        1.737 s, estimated 2 s
Ran all test suites.
