# Security Fixes - January 23, 2026

**Date:** 2026-01-23
**Time:** 20:21:53 UTC
**Auditor:** Claude Opus 4.5

---

## Executive Summary

Comprehensive security audit and fixes applied to the AiMoviez application. A total of **12 vulnerabilities** were identified and fixed across multiple severity levels.

---

## Fixes Applied

### Critical Severity

#### 1. Cron Endpoint Unprotected
**File:** `src/app/api/cron/auto-advance/route.ts`

**Issue:** Cron endpoint was accessible without authentication if `CRON_SECRET` was not configured.

**Fix:** Made `CRON_SECRET` mandatory in production environment:
```typescript
if (!cronSecret) {
  if (isProduction) {
    console.error('[auto-advance] CRITICAL: CRON_SECRET not configured in production');
    return NextResponse.json({ error: 'Server misconfiguration' }, { status: 500 });
  }
}
```

**Commit:** `e81d7ab`

---

#### 2. Database Error Disclosure
**Files:**
- `src/app/api/upload/register/route.ts`
- `src/app/api/comments/route.ts`
- `src/app/api/story/route.ts`
- `src/app/api/admin/assign-winner/route.ts`
- `src/app/api/vote/route.ts`

**Issue:** Database error messages were exposed to clients, revealing schema information.

**Fix:** Replaced all database errors with generic messages, logging full errors server-side only:
```typescript
// Before
error: `Failed to save clip: ${clipError.message || 'Database error'}`

// After
error: 'Failed to save clip. Please try again.'
```

**Commit:** `0a76085`

---

### High Severity

#### 3. Username Enumeration
**File:** `src/app/api/user/check-username/route.ts`

**Issue:** Username availability check was accessible without authentication, enabling enumeration attacks.

**Fix:** Added authentication requirement:
```typescript
const session = await getServerSession(authOptions);
if (!session?.user?.email) {
  return NextResponse.json(
    { available: false, error: 'Authentication required' },
    { status: 401 }
  );
}
```

**Commit:** `bf17aff`

---

#### 4. Referral Code Enumeration
**File:** `src/app/api/referral/route.ts`

**Issue:** Different responses for valid/invalid referral codes enabled code enumeration.

**Fix:** Return identical responses regardless of code validity:
```typescript
if (referrerError || !referrer) {
  console.warn('[REFERRAL] Invalid code attempt:', referral_code.slice(0, 4) + '***');
  return NextResponse.json({
    success: true,
    message: 'Referral code processed',
    reward_amount: 0,
  });
}
```

**Commit:** `bf17aff`

---

#### 5. Comment Deletion Auth Bypass
**File:** `src/app/api/comments/route.ts`

**Issue:** Comment deletion only checked `isAuthenticated` but not `userId`, potentially allowing device fingerprint bypass.

**Fix:** Added double-check for both flags:
```typescript
if (!userInfo.isAuthenticated || !userInfo.userId) {
  return NextResponse.json(
    { error: 'Authentication required to delete comments' },
    { status: 401 }
  );
}
```

**Commit:** `0a76085`

---

#### 6. Account Export Null Check
**File:** `src/app/api/account/export/route.ts`

**Issue:** Queries executed with `profile?.id || ''` which could return unintended data if profile lookup failed.

**Fix:** Only query user data if profile exists with valid ID:
```typescript
if (profile?.id) {
  const { data: clipsData } = await supabase
    .from('tournament_clips')
    .select('...')
    .eq('user_id', profile.id);
  // ...
}
```

**Commit:** `0a76085`

---

#### 7. Weak XSS Sanitization
**File:** `src/app/api/contact/route.ts`

**Issue:** Regex-based XSS sanitization was bypassable.

**Fix:** Replaced with proper HTML entity encoding using `escapeHtml()`:
```typescript
import { escapeHtml } from '@/lib/sanitize';

function sanitizeInput(input: string): string {
  if (!input) return '';
  const escaped = escapeHtml(input);
  return escaped
    .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '')
    .trim();
}
```

**Commit:** `0a76085`

---

### Medium Severity

#### 8. JWT Cache Too Long
**File:** `src/lib/auth-options.ts`

**Issue:** JWT profile cache TTL was 1 hour, delaying role change propagation (e.g., admin demotion).

**Fix:** Reduced to 5 minutes:
```typescript
const PROFILE_CACHE_TTL = 5 * 60 * 1000; // 5 minutes
```

**Commit:** `48e8c25`

---

#### 9. Missing CSP Header
**File:** `src/middleware.ts`

**Issue:** No Content-Security-Policy header was set.

**Fix:** Added comprehensive CSP:
```typescript
const cspDirectives = [
  "default-src 'self'",
  "script-src 'self' 'unsafe-inline' 'unsafe-eval'",
  "style-src 'self' 'unsafe-inline'",
  "img-src 'self' data: blob: https://*.supabase.co https://api.dicebear.com https://*.googleusercontent.com",
  "font-src 'self' https://fonts.gstatic.com",
  "connect-src 'self' https://*.supabase.co wss://*.supabase.co https://accounts.google.com",
  "media-src 'self' blob: https://*.supabase.co",
  "frame-ancestors 'none'",
  "form-action 'self'",
  "base-uri 'self'",
  "object-src 'none'",
];
```

**Commit:** `a4fdf07`

---

#### 10. Missing HSTS Header
**File:** `src/middleware.ts`

**Issue:** No Strict-Transport-Security header for HTTPS enforcement.

**Fix:** Added HSTS in production:
```typescript
if (process.env.NODE_ENV === 'production') {
  response.headers.set(
    'Strict-Transport-Security',
    'max-age=31536000; includeSubDomains'
  );
}
```

**Commit:** `0a76085`

---

#### 11. Admin Rate Limits Too High
**File:** `src/lib/rate-limit.ts`

**Issue:** Single admin rate limit (50 req/min) was too permissive for sensitive operations.

**Fix:** Split into tiered limits:
```typescript
admin: { requests: 30, window: '1m' as const },
admin_read: { requests: 30, window: '1m' as const },
admin_write: { requests: 15, window: '1m' as const },
admin_sensitive: { requests: 5, window: '1m' as const },
```

**Updated routes:**
- GET endpoints → `admin_read`
- POST/DELETE moderation → `admin_write`
- PUT user actions (ban/roles) → `admin_sensitive`

**Commit:** `f357a50`

---

#### 12. Audit Log Field Exposure
**File:** `src/lib/audit-log.ts`

**Issue:** Sensitive data stored in audit logs (admin email, notes, IP addresses).

**Fix:** Added redaction before storage:
```typescript
function redactSensitiveDetails(details: Record<string, unknown>): Record<string, unknown> {
  const redacted = { ...details };

  // Hash admin notes
  if (typeof redacted.adminNotes === 'string' && redacted.adminNotes) {
    redacted.adminNotes_hash = hashSensitiveText(redacted.adminNotes);
    redacted.adminNotes_length = redacted.adminNotes.length;
    delete redacted.adminNotes;
  }
  // ... similar for reason, admin_notes, email

  return redacted;
}

// Also hash IP addresses
const ipHash = crypto.createHash('sha256').update(ipAddress).digest('hex').substring(0, 16);
```

**Commit:** `f357a50`

---

## Commits Summary

| Commit | Description |
|--------|-------------|
| `e81d7ab` | SECURITY: Require CRON_SECRET in production |
| `bf17aff` | SECURITY: Fix username and referral code enumeration |
| `48e8c25` | SECURITY: Reduce JWT profile cache from 1 hour to 5 minutes |
| `a4fdf07` | SECURITY: Add Content-Security-Policy header |
| `0a76085` | SECURITY: Fix multiple vulnerabilities from audit |
| `f357a50` | SECURITY: Stricter admin rate limits and audit log redaction |

---

## Files Modified

- `src/middleware.ts`
- `src/lib/auth-options.ts`
- `src/lib/rate-limit.ts`
- `src/lib/audit-log.ts`
- `src/app/api/cron/auto-advance/route.ts`
- `src/app/api/user/check-username/route.ts`
- `src/app/api/referral/route.ts`
- `src/app/api/upload/register/route.ts`
- `src/app/api/comments/route.ts`
- `src/app/api/story/route.ts`
- `src/app/api/admin/assign-winner/route.ts`
- `src/app/api/admin/moderation/route.ts`
- `src/app/api/admin/users/route.ts`
- `src/app/api/admin/users/[id]/route.ts`
- `src/app/api/account/export/route.ts`
- `src/app/api/contact/route.ts`
- `src/app/api/vote/route.ts`

---

## Recommendations for Future

1. **CSP Nonces:** Consider implementing nonce-based CSP for inline scripts (requires Next.js middleware changes)
2. **Penetration Testing:** Add to CI/CD pipeline
3. **API Key Rotation:** Implement rotation policy for Supabase keys
4. **Security Headers:** Consider adding `Expect-CT` and `X-Permitted-Cross-Domain-Policies`

---

*Generated by Claude Opus 4.5 Security Audit*
