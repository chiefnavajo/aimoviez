# AI Video Generation — Integration Plan

## Overview

Add AI-powered video clip generation to Aimoviez. Users type a text prompt and get an 8-second video clip generated by AI, which enters the tournament like any uploaded clip.

**Two entry points:**
- Upload page: "AI Generate" tab alongside existing "Upload Video"
- Dedicated `/create` page: full prompt builder with styles, history, model picker

---

## AI Provider Strategy

**Single-provider approach:** All models via fal.ai. One API key, one SDK, one webhook flow.

| Tier | Model | Provider | Cost/8s clip | Duration | Gen Time | Quality | Audio |
|------|-------|----------|-------------|----------|----------|---------|-------|
| **Free (default)** | MiniMax Hailuo 2.3 | fal.ai | ~$0.49 | 6-10s | 2-3 min | High | No |
| **Standard** | Kling 2.6 | fal.ai | ~$0.40-$0.96 | 5-10s | 1-2 min | Very High | Yes |
| **Premium** | Google Veo 3 Fast | fal.ai | ~$0.80-$1.20 | 8s | 1-3 min | Very High | Yes |

**Why single-provider (fal.ai only)?**
- One API key, one webhook flow, one SDK — minimal integration complexity
- Kling 2.6 is the most widely adopted model globally, best price-to-quality ratio
- Veo 3 Fast wins quality benchmarks, has native audio, and is cheaper than Veo 3.1 Standard
- No OpenAI account/billing to manage ($50 minimum Tier 2 access eliminated)
- Adding future models (Runway, Wan, Luma) is just a config entry — no new provider code

**8-second strategy:** Hailuo generates 6s or 10s — accept 6-10s range. Kling generates 5-10s. Veo 3 Fast supports custom duration (use `8`).

*Future consideration:* OpenAI Sora 2 can be added later as a fourth option via direct OpenAI API if users request it.

**Env vars (server-only):**
```
FAL_KEY=fal-xxxxxxxxxxxxxxxx        # fal.ai API key (all models)
```

---

## Architecture

```
User → Prompt → POST /api/ai/generate → fal.ai (async)
                     ↓
              ai_generations row (status: pending)
                     ↓
Frontend polls GET /api/ai/status/[id] every 3s
                     ↓
fal.ai completes → video URL available
                     ↓
User clicks "Submit" → POST /api/ai/complete
  ↓ Download from fal.ai
  ↓ Upload to Supabase/R2
  ↓ Insert tournament_clips (status: pending, is_ai_generated: true)
  ↓ Admin approves → active → enters voting
```

---

## Phase 1: Database & Infrastructure

### 1A. Migration

**New file:** `supabase/sql/migration-ai-video-generation.sql`

```sql
-- AI columns on tournament_clips
ALTER TABLE tournament_clips
  ADD COLUMN IF NOT EXISTS is_ai_generated BOOLEAN DEFAULT FALSE,
  ADD COLUMN IF NOT EXISTS ai_prompt TEXT,
  ADD COLUMN IF NOT EXISTS ai_model VARCHAR(50),
  ADD COLUMN IF NOT EXISTS ai_generation_id VARCHAR(200),
  ADD COLUMN IF NOT EXISTS ai_style VARCHAR(50);

CREATE INDEX IF NOT EXISTS idx_clips_ai_generated
  ON tournament_clips(is_ai_generated) WHERE is_ai_generated = TRUE;

-- Generation tracking table
CREATE TABLE IF NOT EXISTS ai_generations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  fal_request_id VARCHAR(200) NOT NULL,
  status VARCHAR(20) DEFAULT 'pending',
  prompt TEXT NOT NULL,
  model VARCHAR(50) NOT NULL,
  style VARCHAR(50),
  genre VARCHAR(20),
  video_url TEXT,
  clip_id UUID,
  error_message TEXT,
  cost_cents INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  CONSTRAINT valid_ai_status CHECK (status IN ('pending', 'processing', 'completed', 'failed'))
);

CREATE INDEX IF NOT EXISTS idx_ai_gen_user ON ai_generations(user_id);
CREATE INDEX IF NOT EXISTS idx_ai_gen_fal_id ON ai_generations(fal_request_id);

-- Daily generation limits
CREATE TABLE IF NOT EXISTS ai_generation_limits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  date DATE NOT NULL DEFAULT CURRENT_DATE,
  generation_count INTEGER DEFAULT 0,
  UNIQUE(user_id, date)
);

-- Feature flag
INSERT INTO feature_flags (key, name, description, category, enabled, config) VALUES
  ('ai_video_generation', 'AI Video Generation', 'Allow AI clip generation via fal.ai', 'creation', FALSE,
   '{"default_model": "hailuo-2.3", "max_daily_free": 1, "available_models": ["hailuo-2.3", "kling-2.6", "veo3-fast"], "max_prompt_length": 500, "daily_cost_limit_cents": 5000, "monthly_cost_limit_cents": 150000}')
ON CONFLICT (key) DO NOTHING;
```

### 1B. AI Video Integration Library

**New file:** `src/lib/ai-video.ts`

Unified interface over fal.ai. Each model maps to a fal.ai model ID + config:

```typescript
interface ModelConfig {
  modelId: string;          // fal.ai model ID
  costCents: number;        // per generation
  duration: string;         // e.g. "6s", "8", "5s"
  resolution: string;
  supportsAudio: boolean;
}

const MODELS: Record<string, ModelConfig> = {
  'hailuo-2.3': {
    modelId: 'fal-ai/minimax/hailuo-2.3/pro/text-to-video',
    costCents: 49,
    duration: '6s',
    resolution: '720p',
    supportsAudio: false,
  },
  'kling-2.6': {
    modelId: 'fal-ai/kling-video/v2.6/standard/text-to-video',
    costCents: 70,
    duration: '5s',
    resolution: '720p',
    supportsAudio: true,
  },
  'veo3-fast': {
    modelId: 'fal-ai/veo3/fast',
    costCents: 100,
    duration: '8',
    resolution: '720p',
    supportsAudio: true,
  },
};
```

Core functions:
- `startGeneration(prompt, model, style, genre)` → calls fal.ai Queue API with webhook, returns `{ requestId }`
- `checkStatus(requestId)` → reads our DB (webhook updates it), returns `{ status, videoUrl, error }`

**fal.ai path:** Queue API at `https://queue.fal.run/{modelId}` with webhook

`downloadAndStore` removed per bug fix #1 — client uploads directly via signed URL.

**NPM package (must be installed — not in package.json):**
- `@fal-ai/client` (fal.ai SDK) — `npm install @fal-ai/client`

### 1C. Validation Schemas

**Modify:** `src/lib/validations.ts` — add `AIGenerateSchema`:
- `prompt`: string, 10-500 chars, trimmed
- `model`: enum `['hailuo-2.3', 'kling-2.6', 'veo3-fast']`, default `'hailuo-2.3'`
- `style`: optional enum `['cinematic', 'anime', 'realistic', 'abstract', 'noir', 'retro', 'neon']`
- `genre`: optional string

### 1D. Rate Limit

**Modify:** `src/lib/rate-limit.ts` — add `ai_generate: { requests: 3, window: '1m' }`

### 1E. Types

**Modify:** `src/types/index.ts` — add `AIGeneration`, `AIModel`, `AIStyle` interfaces

---

## Phase 2: API Routes

### 2A. `POST /api/ai/generate`

**New file:** `src/app/api/ai/generate/route.ts`

1. Rate limit (`ai_generate`)
2. Auth required (NextAuth session)
3. Check `ai_video_generation` feature flag enabled
4. Validate body with `AIGenerateSchema`
5. Check daily limit: query `ai_generation_limits` for user + today, compare to config
6. Sanitize prompt (reuse existing `sanitizeText` from `src/lib/sanitize.ts`)
7. Call `startGeneration()` → get fal.ai `requestId`
8. Insert `ai_generations` row (status: `pending`)
9. Upsert `ai_generation_limits` (increment count)
10. Return `{ ok: true, generationId, status: 'pending', estimatedSeconds: 120 }`

### 2B. `GET /api/ai/status/[id]`

**New file:** `src/app/api/ai/status/[id]/route.ts`

1. Auth required
2. Look up `ai_generations` by `id`, verify user owns it
3. If status `pending`/`processing`: call `checkStatus(fal_request_id)`
4. Update row if status changed
5. Return `{ status, videoUrl, progress, error }`

### 2C. `POST /api/ai/complete`

**New file:** `src/app/api/ai/complete/route.ts`

1. Auth + rate limit
2. Look up generation, verify user owns it, status is `completed`
3. Download video from fal.ai URL
4. Upload to Supabase/R2 (reuse `src/lib/storage/` abstraction)
5. Get active season + voting/waiting slot (same pattern as `src/app/api/upload/register/route.ts` lines 99-132)
6. Insert `tournament_clips` row:
   - All standard fields (season_id, slot_position, genre, username, etc.)
   - `is_ai_generated: true`
   - `ai_prompt`, `ai_model`, `ai_generation_id`, `ai_style`
   - `status: 'pending'`
7. Update `ai_generations` with `clip_id`
8. Return `{ ok: true, clipId }`

### 2D. `GET /api/ai/history`

**New file:** `src/app/api/ai/history/route.ts`

Auth required. Returns user's last 20 generations ordered by `created_at DESC`.

---

## Phase 3: Upload Page — AI Tab

**Modify:** `src/app/upload/page.tsx`

Changes:
1. Add `useFeature('ai_video_generation')` check
2. Add tab toggle at Step 1: **"Upload Video" | "AI Generate"** (hidden when flag off)
3. When AI tab selected, render `<AIGeneratePanel />` instead of file drop zone
4. Genre from Step 2 passed to panel as `preselectedGenre`

### AIGeneratePanel Component

**New file:** `src/components/AIGeneratePanel.tsx`

```
Props: { preselectedGenre?, onComplete?, compact? }
```

UI:
1. **Prompt textarea** — 500 char limit, placeholder suggestions, character counter
2. **Style pills** — grid of style options (cinematic, anime, realistic, etc.)
3. **Genre auto-select** — from parent or manual pick
4. **Generate button** — gradient, shows daily limit ("2 of 3 remaining")
5. **Progress indicator** — animated bar with stages (Submitting → Generating → Finalizing → Ready)
6. **Video preview** — when complete, show in 9:16 player (same as upload preview)
7. **Submit to Tournament** button — calls `/api/ai/complete`
8. **Regenerate** button — start over with same prompt

Polling: `useEffect` with `setInterval(3000)` checking `/api/ai/status/[id]`.

Uses `useCsrf()` for POST requests (existing pattern).

---

## Phase 4: Dedicated `/create` Page

**New file:** `src/app/create/page.tsx`

Full-screen AI creation experience:
1. **Prompt builder** — large textarea with suggestion chips ("epic space battle", "noir detective", "cute animation")
2. **Style cards** — visual grid with style previews
3. **Model picker** — cards showing model name, provider badge (fal.ai/OpenAI), cost, quality tier
4. **Genre selector** — reuse existing genre grid
5. **`<AIGeneratePanel compact={false} />`** — full generation experience
6. **Generation history** — grid of past generations with status, thumbnails, retry buttons

### Hook

**New file:** `src/hooks/useAIGenerations.ts`

React Query wrapper for `/api/ai/history`:
```typescript
useQuery({ queryKey: ['ai-generations'], queryFn: ..., staleTime: 30_000 })
```

### Navigation

**Modify:** `src/components/BottomNavigation.tsx` — add "Create" item with `Sparkles` icon, conditionally shown when `ai_video_generation` flag enabled.

---

## Phase 5: Admin & Safety

### 5A. Admin Dashboard

**Modify:** `src/app/admin/page.tsx`

- Add `is_ai_generated`, `ai_prompt`, `ai_model` to clip interface
- Show "AI" badge on AI-generated clips in the clip list
- Show prompt text in clip detail/expand view
- Add "AI Only" filter option

### 5B. Admin Clips API

**Modify:** `src/app/api/admin/clips/route.ts`

- Add `is_ai_generated, ai_prompt, ai_model` to `.select()`
- Add `?ai_only=true` query parameter support

### 5C. Cost Tracking

**New file:** `src/app/api/admin/ai-stats/route.ts`

Admin-only endpoint returning:
- Generations today / this week / this month
- Total cost (sum `cost_cents`)
- Success/failure ratio
- Top users by generation count
- Cost breakdown by model

### 5D. Prompt Safety

- Server-side keyword blocklist before sending to fal.ai (reuse `sanitizeText` pattern)
- All prompts stored in DB for admin review
- AI clips go through same admin approval flow as manual uploads

---

## Files Summary

### New Files (12)

| File | Purpose |
|------|---------|
| `supabase/sql/migration-ai-video-generation.sql` | DB migration |
| `src/lib/ai-video.ts` | fal.ai integration library |
| `src/app/api/ai/generate/route.ts` | Start generation |
| `src/app/api/ai/status/[id]/route.ts` | Poll status |
| `src/app/api/ai/complete/route.ts` | Download + register clip |
| `src/app/api/ai/history/route.ts` | User's generation history |
| `src/app/api/admin/ai-stats/route.ts` | Admin cost tracking |
| `src/components/AIGeneratePanel.tsx` | Shared generation UI |
| `src/app/create/page.tsx` | Dedicated create page |
| `src/hooks/useAIGenerations.ts` | Generation history hook |

### Modified Files (7)

| File | Change |
|------|--------|
| `src/lib/validations.ts` | Add AI generation Zod schemas |
| `src/lib/rate-limit.ts` | Add `ai_generate` rate limit |
| `src/types/index.ts` | Add AI types |
| `src/app/upload/page.tsx` | Add AI Generate tab |
| `src/app/admin/page.tsx` | AI badges + prompt display |
| `src/app/api/admin/clips/route.ts` | AI fields in query |
| `src/components/BottomNavigation.tsx` | Add Create nav item |

---

## Dependencies & Parallelization

```
Phase 1 (all parallel) ─── Phase 2 (all parallel) ─── Phase 3 (upload tab)
                                                    └── Phase 4 (/create page)
                                                    └── Phase 5 (admin, parallel with 3/4)
```

- Phase 3 component can start with mocked API before Phase 2 is done
- Phase 5 admin changes are independent of Phase 3/4

---

## Cost Control

| Protection | How |
|------------|-----|
| Daily per-user limit | `ai_generation_limits` table, checked server-side before every generation |
| Rate limiting | 3 requests/minute per user at API level |
| Feature flag | `ai_video_generation` — instant kill switch |
| Admin approval | AI clips get `status: pending`, same as manual uploads |
| Cost tracking | `cost_cents` on every generation, admin dashboard shows totals |
| No client-side keys | `FAL_KEY` is server-only env var |

---

## Env Vars

```
FAL_KEY=fal-xxxxxxxxxxxxxxxx        # fal.ai API key (server-only)
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxx  # OpenAI API key for Sora (server-only)
```

---

## Bug Analysis — Issues Found & Fixes

### CRITICAL (5)

**1. Server OOM: `downloadAndStore()` downloads video on Vercel serverless**
The plan proposes downloading video from fal.ai on the server and re-uploading to storage. Vercel has 256MB-1GB memory and 10-60s timeout. A 30MB video = ~60MB peak memory (fetch buffer + Node.js Buffer). This contradicts the existing signed-URL pattern where the browser uploads directly.

**FIX**: Don't download on server. Instead: (a) `/api/ai/complete` generates a signed upload URL via existing `src/lib/storage/`, (b) returns both the fal.ai video URL and the signed upload URL to the client, (c) client fetches from fal.ai and PUTs to storage directly (same pattern as regular upload). Server only registers the clip metadata.

**2. Multi-active-season crash copied into `/api/ai/complete`**
Plan says "same pattern as upload/register" which uses `.single()` — crashes with multiple active seasons.

**FIX**: Use `.limit(1)` without `.single()`. Access `data?.[0]` instead.

**3. Race condition: daily limit checked BEFORE fal.ai call, incremented AFTER**
Two concurrent requests both read `count=4` (limit 5), both pass, both call fal.ai = 6 generations.

**FIX**: Use atomic upsert-with-check BEFORE calling fal.ai:
```sql
INSERT INTO ai_generation_limits (user_id, date, generation_count)
VALUES ($1, CURRENT_DATE, 1)
ON CONFLICT (user_id, date)
DO UPDATE SET generation_count = generation_count + 1
WHERE ai_generation_limits.generation_count < $limit
RETURNING generation_count;
```
Zero rows returned = limit reached. If fal.ai fails afterward, decrement.

**4. No CSRF protection on AI endpoints**
Each generation costs real money. Cross-origin POST could drain budget. The `requireCsrf()` function exists in `src/lib/csrf.ts` but isn't referenced.

**FIX**: Add `requireCsrf(request)` to `/api/ai/generate` and `/api/ai/complete`.

**5. Daily limit timezone mismatch**
`CURRENT_DATE` is UTC on Vercel. Users in different timezones could get extra generations around midnight.

**FIX**: Explicitly use UTC everywhere. Use `getStartOfTodayUTC()` from `src/lib/api-utils.ts` for queries. Document UTC as the standard.

### HIGH (8)

**6. URL validation rejects fal.ai URLs**
Existing `RegisterClipSchema` allowlists `*.supabase.co`, `*.r2.dev`, `cdn.aimoviez.app`. With the client-side upload fix (#1), the final URL IS on our storage — but validate it anyway.

**FIX**: In `/api/ai/complete`, construct the public URL server-side (never from client input) and validate against the allowlist.

**7. Feature flag must be checked server-side independently**
Frontend `useFeature()` check is bypassable via direct API call.

**FIX**: Each AI API route queries `feature_flags` table directly using service role client (same pattern as `upload/signed-url` lines 79-83).

**8. SSRF risk downloading from fal.ai**
If `video_url` is manipulated, server-side `fetch()` could hit internal services.

**FIX**: With client-side upload fix (#1), server never fetches the URL. If server-side download is ever needed, validate hostname matches `*.fal.media` or `*.fal.ai` and use `sanitizeUrl()` from `src/lib/sanitize.ts`.

**9. Orphaned storage files on partial failure**
Upload succeeds but clip insertion fails → orphaned file in storage.

**FIX**: Check season/slot existence BEFORE returning signed URL. If clip insert fails, client doesn't upload. Add cleanup job for files with no matching clip.

**10. No prompt size limit on DB column**
`ai_prompt TEXT` has no limit. 100KB prompt bloats DB + API responses.

**FIX**: Use `VARCHAR(2000)`. Zod validates to 500 chars (plan already says this), but DB constraint adds defense in depth.

**11. Polling-only architecture overwhelms fal.ai**
Each user poll = call to fal.ai. 100 users * every 3s = 2000 req/min to fal.ai.

**FIX**: Use fal.ai webhooks. Add `POST /api/ai/webhook` (unauthenticated, verify shared secret). fal.ai POSTs completion → updates DB. Frontend polls only our DB (cheap). Fall back to fal.ai polling only if webhook doesn't fire within timeout.

**12. No global cost cap**
Per-user daily limits exist, but total platform spend = `daily_limit * active_users * cost`.

**FIX**: Add `daily_cost_limit_cents` and `monthly_cost_limit_cents` to feature flag config. Check `SUM(cost_cents)` before allowing generation.

**13. Missing RLS on new tables**
`ai_generations` and `ai_generation_limits` need RLS. Without it, anyone with the public anon key can read all prompts and modify limits.

**FIX**: Enable RLS. Add `FOR SELECT USING (user_id = auth.uid())` on both tables. Service role bypasses RLS for admin/server operations.

### MEDIUM (9)

14. **Genre mismatch**: Frontend `'scifi'` vs validation `'sci-fi'`. Fix: align both.
15. **No audit logging for AI actions**: Add `'ai_generate' | 'ai_complete'` to `AuditAction` type.
16. **AI clips don't trigger voting timer**: Extract timer logic from `upload/register` into shared utility, call from `ai/complete` too.
17. **Status endpoint info leak**: Return 404 for both not-found and not-owned. Never expose `fal_request_id`.
18. **Config schema not validated**: Parse feature flag config with Zod at read time.
19. **History endpoint lacks pagination**: Use existing `validatePagination()` pattern.
20. **`completed_at` never set**: Set it in webhook handler or status polling when transition to `completed`.
21. **No `ON DELETE SET NULL`** on `ai_generations.clip_id` FK — would block clip deletion.
22. **`ai_style` needs validation**: Define enum, validate with Zod, sanitize.

### ADDITIONAL BUGS (found in re-analysis)

**23. CRITICAL: Wrong fal.ai webhook signature header**
Plan originally used `X-Fal-Signature` — the correct header is `X-Fal-Webhook-Signature`. Would silently reject all legitimate webhooks. **FIXED inline above.**

**24. CRITICAL: Wrong fal.ai JWKS endpoint URL**
Plan originally used `https://queue.fal.run/.well-known/jwks.json` — the correct URL is `https://rest.alpha.fal.ai/.well-known/jwks.json`. Would break all webhook verification. **FIXED inline above.**

**25. HIGH: Sora 2 Pro has different durations than Sora 2**
Sora 2 supports 4, 8, 12 seconds. Sora 2 Pro supports 10, 15, 25 seconds — NOT the same. Requesting `duration: 8` from Sora 2 Pro would fail with API error. **FIXED inline above** — use 10s for Pro tier.

**26. HIGH: Sora API does support webhooks**
Plan originally claimed Sora uses polling only. OpenAI Sora API does support webhooks, though reliability has been reported as inconsistent. **FIXED inline above** — use webhook as primary, polling as fallback.

**27. MEDIUM: Veo 3.1 cost is variable, not fixed $3.20**
Pricing: $0.20/sec without audio, $0.40/sec with audio (standard). Fast tier: $0.10-$0.15/sec. For 8 seconds: $1.60 (no audio) to $3.20 (with audio). **FIXED inline above** — show range in provider table.

**28. MEDIUM: OpenAI Tier 2 access may require $50, not $10**
Some sources indicate $50 minimum credit purchase for Tier 2 API access. **FIXED inline above** — budget $50 and verify before purchasing.

**29. LOW: NPM dependencies not in package.json**
Neither `@fal-ai/client` nor `openai` is currently installed. **FIXED inline above** — added explicit install commands.

---

## Revised Architecture (incorporating fixes)

```
User → Prompt → POST /api/ai/generate
  ↓ CSRF check
  ↓ Feature flag check (server-side)
  ↓ Atomic daily limit increment
  ↓ Global cost cap check
  ↓ Sanitize prompt
  ↓ Call fal.ai (with webhook_url)
  ↓ Insert ai_generations (status: pending)
  ↓ Return generationId

fal.ai completes → POST /api/ai/webhook (shared secret)
  ↓ Update ai_generations (status: completed, video_url)

Frontend polls GET /api/ai/status/[id] (our DB only, NOT fal.ai)
  ↓ Returns { status, videoUrl } from ai_generations table

User clicks "Submit" → POST /api/ai/complete
  ↓ CSRF check
  ↓ Verify season + slot exist
  ↓ Generate signed upload URL for our storage
  ↓ Return { falVideoUrl, signedUploadUrl, publicUrl }

Client: fetch(falVideoUrl) → PUT to signedUploadUrl (direct to storage)

Client: POST /api/ai/register (new — registers clip metadata)
  ↓ Insert tournament_clips with AI fields
  ↓ Start voting timer if first clip in slot
  ↓ Update ai_generations.clip_id
```

Key changes from original:
- **Client uploads video** (not server) — avoids OOM
- **Webhook-first** for completion — avoids fal.ai polling flood
- **Atomic limit check** — prevents race condition
- **Two-step complete**: `/api/ai/complete` returns URLs, `/api/ai/register` saves metadata
- **CSRF on all mutations**
- **Server-side feature flag check**

---

---

## Deep Dive: fal.ai API Integration Details

### Exact Model IDs & Endpoints

| Model | fal.ai Model ID | Endpoint |
|-------|----------------|----------|
| **Hailuo 2.3 Pro** | `fal-ai/minimax/hailuo-2.3/pro/text-to-video` | `https://queue.fal.run/fal-ai/minimax/hailuo-2.3/pro/text-to-video` |
| **Kling 2.6 Standard** | `fal-ai/kling-video/v2.6/standard/text-to-video` | `https://queue.fal.run/fal-ai/kling-video/v2.6/standard/text-to-video` |
| **Google Veo 3 Fast** | `fal-ai/veo3/fast` | `https://queue.fal.run/fal-ai/veo3/fast` |

### Queue API Flow

```
1. POST https://queue.fal.run/{model_id}
   Headers: { Authorization: "Key $FAL_KEY" }
   Body: { prompt: "...", aspect_ratio: "9:16", duration: "6s" }
   Response: { request_id: "abc123", status_url: "...", response_url: "..." }

2. Webhook fires → POST /api/ai/webhook
   Body: { request_id: "abc123", status: "OK", payload: { video: { url: "..." } } }
   Verify: X-Fal-Webhook-Signature header (ED25519 via JWKS at https://rest.alpha.fal.ai/.well-known/jwks.json)

3. Fallback polling: GET https://queue.fal.run/{model_id}/requests/{request_id}/status
   Response: { status: "IN_PROGRESS" | "COMPLETED", response_url: "..." }
```

### Webhook Setup

Pass webhook URL as query parameter when submitting:
```
POST https://queue.fal.run/{model_id}?fal_webhook={encoded_webhook_url}
```

**Webhook verification:** ED25519 signatures. Fetch public keys from `https://rest.alpha.fal.ai/.well-known/jwks.json`. Verify `X-Fal-Webhook-Signature` header against request body.

### NPM Package

Use `@fal-ai/client` (v1.8.3+):
```typescript
import { fal } from '@fal-ai/client';

fal.config({ credentials: process.env.FAL_KEY });

// Submit to queue with webhook
const result = await fal.queue.submit(modelId, {
  input: { prompt, aspect_ratio: '9:16', duration: '6s' },
  webhookUrl: `${process.env.NEXT_PUBLIC_APP_URL}/api/ai/webhook`,
});
```

### Important Constraints (fal.ai)

- **Concurrent tasks:** Standard tier = 2 concurrent tasks per account. Exceeding → queued.
- **Video URL expiration:** fal.ai video URLs expire after ~7 days. Must download/re-upload to our storage before expiration.
- **Aspect ratio:** Use `9:16` for vertical (matches existing clip format). Also supports `16:9`, `1:1`.
- **Duration options:** Hailuo supports `6s` or `10s`. Kling supports `5s` or `10s`. Veo 3 Fast supports custom duration (use `8`).

### Model-Specific Notes

**Kling 2.6:**
- Most widely adopted AI video model globally (ByteDance/Kuaishou)
- Best price-to-quality ratio
- Native audio generation (sound effects, ambient)
- Supports 720p and 1080p
- Great for realistic humans, lip-sync, dialogue scenes

**Veo 3 Fast:**
- Google's fastest video model, cheaper than Veo 3.1 Standard
- Wins quality benchmarks (MovieGenBench)
- Native audio (dialogue, sound effects, ambient)
- Custom duration support (use `8` for 8 seconds)
- Commercial use allowed

*Future consideration:* OpenAI Sora 2 can be added later via direct OpenAI API (`POST /v1/videos/generations`) if users request it. Would require adding `openai` npm package and a second provider path in `ai-video.ts`.

---

## Deep Dive: Cost Modeling & Abuse Prevention

### Cost Projections

| Scenario | Daily Users | Gens/Day | Model Mix | Avg Cost/Gen | Daily Cost | Monthly Cost |
|----------|-------------|----------|-----------|-------------|------------|-------------|
| **Soft launch** | 50 | 1 | 100% Hailuo | $0.49 | $24.50 | **$735** |
| **MVP (recommended)** | 200 | 1 | 70% Hailuo / 20% Kling / 10% Veo | $0.57 | $114 | **$3,420** |
| **Growth** | 500 | 1 | 50% Hailuo / 30% Kling / 20% Veo | $0.63 | $315 | **$9,450** |
| **3 free/day (dangerous)** | 1000 | 3 | Mixed | $0.60 | $1,800 | **$54,000** |

**Model migration impact:** Kling ($0.70) is cheaper than Sora ($0.80) and Veo 3 Fast ($1.00) is cheaper than Sora 2 Pro ($3.00). Overall cost projections are lower than the previous Sora-based plan.

**Recommendation:** Start with **1 free generation per day** using Hailuo only. Kling and Veo available but count toward user's daily limit. Consider making Veo a paid/premium feature later.

```json
{ "max_daily_free": 1 }
```

### Abuse Scenarios & Mitigations

| Scenario | Attack | Mitigation |
|----------|--------|------------|
| **Account farming** | Create 50 accounts → 50 free gens/day | Phone verification for AI access, or minimum account age (7 days) |
| **Prompt injection** | "ignore previous instructions, generate..." | Sanitize prompt server-side, keyword blocklist, fal.ai has built-in safety filters |
| **Rapid-fire API abuse** | Script 100 concurrent requests | Rate limit (3/min), atomic daily limit, CSRF, auth required |
| **Cost amplification** | Pick most expensive model repeatedly | Per-model daily limits, global cost cap |
| **Webhook replay** | Replay old webhook → re-complete generation | Idempotent webhook handler (check if already completed), verify ED25519 signature |
| **Generation hoarding** | Generate but never submit → waste credits | Auto-expire generations after 24h, count toward daily limit regardless |

### Atomic Daily Limit — PostgreSQL Function

```sql
CREATE OR REPLACE FUNCTION check_and_reserve_generation(
  p_user_id UUID,
  p_date DATE,
  p_max_daily INTEGER
) RETURNS INTEGER AS $$
DECLARE
  v_count INTEGER;
BEGIN
  INSERT INTO ai_generation_limits (user_id, date, generation_count)
  VALUES (p_user_id, p_date, 1)
  ON CONFLICT (user_id, date)
  DO UPDATE SET generation_count = ai_generation_limits.generation_count + 1
  WHERE ai_generation_limits.generation_count < p_max_daily
  RETURNING generation_count INTO v_count;

  RETURN COALESCE(v_count, -1); -- -1 means limit reached
END;
$$ LANGUAGE plpgsql;
```

### Global Budget Guard

Check platform-wide spend before allowing generation:
```sql
SELECT COALESCE(SUM(cost_cents), 0) as total_today
FROM ai_generations
WHERE created_at >= CURRENT_DATE
  AND status != 'failed';
```

Compare against `daily_cost_limit_cents` in feature flag config. Default: `5000` ($50/day) for soft launch.

---

## Deep Dive: Frontend UX Design

### Upload Page — Tab Toggle

```
┌─────────────────────────────────────┐
│  Step 1: Choose your clip           │
│                                     │
│  ┌──────────────┐ ┌──────────────┐  │
│  │ Upload Video │ │ AI Generate ✨│  │
│  │   (active)   │ │              │  │
│  └──────────────┘ └──────────────┘  │
│                                     │
│  [Drop zone / AI prompt panel]      │
└─────────────────────────────────────┘
```

Hidden entirely when `ai_video_generation` feature flag is off.

### AIGeneratePanel — States

**1. Prompt Input (initial)**
```
┌─────────────────────────────────────┐
│ Describe your clip...               │
│ ┌─────────────────────────────────┐ │
│ │                                 │ │
│ │ (textarea, 500 char limit)      │ │
│ │                             0/500│ │
│ └─────────────────────────────────┘ │
│                                     │
│ Style: [Cinematic] [Anime] [Noir]   │
│        [Realistic] [Abstract] ...   │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │  ✨ Generate (1 of 1 remaining) │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

**2. Generating (progress)**
```
┌─────────────────────────────────────┐
│        [animated orb/spinner]       │
│                                     │
│   Creating your masterpiece...      │
│   ━━━━━━━━━━━━░░░░░░ 65%           │
│                                     │
│   Stage: Rendering frames           │
│   ~45 seconds remaining             │
│                                     │
│         [ Cancel ]                  │
└─────────────────────────────────────┘
```

Progress stages: Submitting → Queued → Generating → Rendering → Ready

**3. Preview (complete)**
```
┌─────────────────────────────────────┐
│  ┌─────────────────────────┐        │
│  │                         │        │
│  │   [9:16 video player]   │        │
│  │   with play/pause       │        │
│  │                         │        │
│  └─────────────────────────┘        │
│                                     │
│  "A noir detective walks through..." │
│  Style: Cinematic | Model: Hailuo   │
│                                     │
│  [Submit to Tournament]  [Retry ↻]  │
└─────────────────────────────────────┘
```

**4. Limit reached**
```
┌─────────────────────────────────────┐
│  You've used your daily generation  │
│  Come back tomorrow! ⏰              │
│  Resets at midnight UTC             │
└─────────────────────────────────────┘
```

### /create Page — Full Layout

```
┌─────────────────────────────────────────────┐
│  Create with AI                    [← Back] │
│─────────────────────────────────────────────│
│                                             │
│  Prompt                                     │
│  ┌─────────────────────────────────────────┐│
│  │ (large textarea)                        ││
│  │                                     0/500││
│  └─────────────────────────────────────────┘│
│                                             │
│  Suggestions: [epic battle] [sunset city]   │
│               [cute animal] [space odyssey] │
│                                             │
│  Style          Genre          Model           │
│  ┌────────┐    ┌────────┐    ┌───────────────┐ │
│  │Cinemat.│    │ Action │    │ Hailuo 2.3    │ │
│  │ Anime  │    │ Drama  │    │  Free/Default  │ │
│  │  Noir  │    │ Comedy │    │───────────────│ │
│  │ Reali. │    │ Sci-Fi │    │ Kling 2.6     │ │
│  └────────┘    └────────┘    │  Standard      │ │
│                              │───────────────│ │
│                              │ Veo 3 Fast    │ │
│                              │  Premium ★     │ │
│                              └───────────────┘ │
│                                             │
│  [AIGeneratePanel — progress/preview area]  │
│                                             │
│  ─── Recent Generations ────────────────    │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐       │
│  │thumb │ │thumb │ │thumb │ │thumb │       │
│  │ ✓    │ │ ✓    │ │ ✗    │ │ ⏳   │       │
│  └──────┘ └──────┘ └──────┘ └──────┘       │
└─────────────────────────────────────────────┘
```

---

## Deep Dive: Security Hardening

### Webhook Verification

```typescript
// /api/ai/webhook/route.ts
import { createPublicKey } from 'crypto';

async function verifyFalWebhook(req: NextRequest): Promise<boolean> {
  const signature = req.headers.get('x-fal-webhook-signature');
  if (!signature) return false;

  const body = await req.text();

  // Fetch JWKS from fal.ai (cache for 1 hour)
  const jwks = await fetchCachedJWKS('https://rest.alpha.fal.ai/.well-known/jwks.json');

  // Verify ED25519 signature
  for (const key of jwks.keys) {
    const publicKey = createPublicKey({ key, format: 'jwk' });
    const isValid = verify(null, Buffer.from(body), publicKey, Buffer.from(signature, 'base64'));
    if (isValid) return true;
  }
  return false;
}
```

### Security Checklist

| Risk | Mitigation | Implementation |
|------|------------|----------------|
| **CSRF on mutations** | Double-submit cookie | `requireCsrf(req)` on `/generate`, `/complete`, `/register` |
| **Auth bypass** | Server-side session check | NextAuth `getServerSession()` on every AI endpoint |
| **Feature flag bypass** | Server-side flag check | Query `feature_flags` table, not client state |
| **Video URL spoofing** | Server constructs URL | Never accept video URL from client; server builds public URL from known storage path |
| **Webhook forgery** | ED25519 verification | Verify `X-Fal-Webhook-Signature` against fal.ai JWKS |
| **Webhook replay** | Idempotent handler | Check `ai_generations.status` — if already `completed`, ignore |
| **Prompt injection** | Sanitize + blocklist | `sanitizeText()` + keyword filter before sending to fal.ai |
| **RLS bypass** | Enable RLS on tables | `FOR SELECT USING (user_id = auth.uid())` on `ai_generations`, `ai_generation_limits` |
| **Race on limits** | Atomic PG function | `check_and_reserve_generation()` — single atomic operation |
| **Cost runaway** | Multi-layer caps | Per-user daily + global daily + monthly + feature flag kill switch |

### RLS Policies (add to migration)

```sql
ALTER TABLE ai_generations ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_generation_limits ENABLE ROW LEVEL SECURITY;

-- Users can only read their own generations
CREATE POLICY ai_gen_select ON ai_generations
  FOR SELECT USING (user_id = auth.uid());

-- Users can only read their own limits
CREATE POLICY ai_limits_select ON ai_generation_limits
  FOR SELECT USING (user_id = auth.uid());

-- Service role bypasses RLS (used by API routes and webhook)
```

---

## Updated Files Summary (incorporating all fixes)

### New Files (14)

| File | Purpose |
|------|---------|
| `supabase/sql/migration-ai-video-generation.sql` | DB migration (tables, indexes, RLS, atomic function, feature flag) |
| `src/lib/ai-video.ts` | fal.ai integration library — Hailuo, Kling, Veo via `@fal-ai/client` |
| `src/app/api/ai/generate/route.ts` | Start generation (CSRF, flag, atomic limit, global cap) |
| `src/app/api/ai/status/[id]/route.ts` | Poll status (reads our DB, not fal.ai) |
| `src/app/api/ai/complete/route.ts` | Prepare signed upload URL + metadata |
| `src/app/api/ai/register/route.ts` | Register clip after client uploads video |
| `src/app/api/ai/webhook/route.ts` | fal.ai completion webhook (ED25519 verified) |
| `src/app/api/ai/history/route.ts` | User's generation history (paginated) |
| `src/app/api/admin/ai-stats/route.ts` | Admin cost tracking dashboard data |
| `src/components/AIGeneratePanel.tsx` | Shared generation UI (prompt → progress → preview) |
| `src/app/create/page.tsx` | Dedicated create page (full prompt builder) |
| `src/hooks/useAIGenerations.ts` | React Query hook for generation history |

### Modified Files (8)

| File | Change |
|------|--------|
| `src/lib/validations.ts` | Add `AIGenerateSchema` with Zod |
| `src/lib/rate-limit.ts` | Add `ai_generate` rate limit tier |
| `src/lib/audit-log.ts` | Add `'ai_generate' \| 'ai_complete'` to `AuditAction` |
| `src/types/index.ts` | Add `AIGeneration`, `AIModel`, `AIStyle` types |
| `src/app/upload/page.tsx` | Add AI Generate tab toggle |
| `src/app/admin/page.tsx` | AI badges, prompt display, AI-only filter |
| `src/app/api/admin/clips/route.ts` | Add AI fields to query + `?ai_only` param |
| `src/components/BottomNavigation.tsx` | Add "Create" nav item (conditional on flag) |

---

## Verification

1. `npx next build` — no errors after each phase
2. Feature flag OFF → no AI UI visible anywhere, API returns 403
3. Feature flag ON → AI tab on upload page, /create page accessible
4. Generate clip → poll status → preview → submit → appears in admin pending queue
5. Daily limit reached → shows "limit reached" message, API returns 429
6. Admin sees AI badge + prompt on generated clips
7. Admin cost dashboard shows generation counts and costs
8. Two concurrent generate requests from same user at limit → only one succeeds
9. fal.ai webhook fires → generation status updates without polling
10. Client-side upload of AI video → file lands in correct storage bucket
11. Webhook without valid ED25519 signature → rejected with 401
12. Direct API call without CSRF token → rejected with 403
13. Global daily cost cap exceeded → all users see "service temporarily unavailable"
14. Generation with `status: completed` receives duplicate webhook → no-op
