# AI Video Generation — Integration Plan

## Overview

Add AI-powered video clip generation to Aimoviez. Users type a text prompt and get an 8-second video clip generated by AI, which enters the tournament like any uploaded clip.

**Two entry points:**
- Upload page: "AI Generate" tab alongside existing "Upload Video"
- Dedicated `/create` page: full prompt builder with styles, history, model picker

---

## AI Provider Strategy

**Single-provider approach:** All models via fal.ai. One API key, one SDK, one webhook flow.

| Tier | Model | Provider | Cost/clip | Duration | Gen Time | Quality | Audio |
|------|-------|----------|----------|----------|----------|---------|-------|
| **Free (default)** | MiniMax Hailuo 2.3 Pro | fal.ai | ~$0.49 flat | 6s default | 2-3 min | High | No (TTS addon only) |
| **Standard** | Kling 2.6 Pro | fal.ai | ~$0.35-$1.40 ($0.07/s no audio, $0.14/s with audio) | 5s or 10s | 1-2 min | Very High | Yes (native) |
| **Premium** | Google Veo 3 Fast | fal.ai | ~$0.80-$1.20 ($0.10/s no audio, $0.15/s with audio) | 8s custom | 1-3 min | Very High | Yes (native) |

**Why single-provider (fal.ai only)?**
- One API key, one webhook flow, one SDK — minimal integration complexity
- Kling 2.6 Pro is the most widely adopted model globally, best price-to-quality ratio
- Veo 3 Fast wins quality benchmarks, has native audio, and is cheaper than Veo 3.1 Standard
- No OpenAI account/billing to manage ($50 minimum Tier 2 access eliminated)
- Adding future models (Runway, Wan, Luma) is just a config entry — no new provider code

**Duration strategy:** Hailuo generates ~6s (fixed, not configurable). Kling generates 5s or 10s (use `"5"` string, no `s` suffix — **restrict to 5s only** since 10s exceeds `MAX_VIDEO_DURATION=8.5`). Veo 3 Fast supports custom duration (use `"8s"` string with `s` suffix). Accept 5-8s range across models.

> **CRITICAL — Parameter differences between models:**
> - **Hailuo:** Only accepts `prompt` and `prompt_optimizer` (boolean). Does NOT accept `aspect_ratio`, `video_size`, or `duration`. Output is **landscape by default** with no way to request portrait 9:16. This is a significant limitation for a vertical-video app. Resolution is fixed at 1080p.
> - **Kling:** Duration format is `"5"` or `"10"` (string, no `s` suffix). Supports `aspect_ratio: "9:16"`. Has `generate_audio` param (defaults to `true` — doubles cost if not explicitly disabled). Has `negative_prompt` and `cfg_scale` params.
> - **Veo 3:** Duration format is `"8s"` (string WITH `s` suffix). Supports `aspect_ratio: "9:16"`. Has `generate_audio` param (defaults to `true` — doubles cost if not explicitly disabled). Has `negative_prompt`, `resolution`, and `seed` params.
>
> **Hailuo portrait limitation:** Since Hailuo cannot generate 9:16 video, either: (a) exclude Hailuo from the initial launch and use Kling as the free tier, (b) accept landscape output from Hailuo and display letterboxed, or (c) post-process with ffmpeg to crop/rotate (adds complexity). **Recommendation: start with Kling as default, Veo as premium.**

*Future consideration:* OpenAI Sora 2 can be added later as a fourth option via direct OpenAI API if users request it.

**Env vars (server-only):**
```
FAL_KEY=fal-xxxxxxxxxxxxxxxx        # fal.ai API key (all models)
```

---

## Architecture

> See "Revised Architecture" section below for the full corrected flow with all security checks. Simplified overview:

```
User → Prompt → POST /api/ai/generate → fal.ai Queue API (async, with webhook)
                     ↓
              ai_generations row (status: pending)
                     ↓
fal.ai webhook → POST /api/ai/webhook → updates ai_generations (completed)
                     ↓
Frontend polls GET /api/ai/status/[id] (our DB only)
                     ↓
User clicks "Submit" → POST /api/ai/complete → returns signed upload URL
  ↓ Client fetches video from fal.ai CDN
  ↓ Client PUTs to signed URL (direct to Supabase/R2)
  ↓ Client calls POST /api/ai/register → inserts tournament_clips
  ↓ Admin approves → active → enters voting
```

---

## Phase 1: Database & Infrastructure

### 1A. Migration

**New file:** `supabase/sql/migration-ai-video-generation.sql`

```sql
-- AI columns on tournament_clips
ALTER TABLE tournament_clips
  ADD COLUMN IF NOT EXISTS is_ai_generated BOOLEAN DEFAULT FALSE,
  ADD COLUMN IF NOT EXISTS ai_prompt TEXT,
  ADD COLUMN IF NOT EXISTS ai_model VARCHAR(50),
  ADD COLUMN IF NOT EXISTS ai_generation_id VARCHAR(200),
  ADD COLUMN IF NOT EXISTS ai_style VARCHAR(50);

CREATE INDEX IF NOT EXISTS idx_clips_ai_generated
  ON tournament_clips(is_ai_generated) WHERE is_ai_generated = TRUE;

-- Generation tracking table
CREATE TABLE IF NOT EXISTS ai_generations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  fal_request_id VARCHAR(200) NOT NULL,
  status VARCHAR(20) DEFAULT 'pending',
  prompt VARCHAR(2000) NOT NULL,            -- VARCHAR(2000) not TEXT — defense in depth (Zod validates to 500)
  model VARCHAR(50) NOT NULL,
  style VARCHAR(50),
  genre VARCHAR(20),
  video_url TEXT,
  clip_id UUID REFERENCES tournament_clips(id) ON DELETE SET NULL,  -- allows clip deletion without blocking
  error_message TEXT,
  cost_cents INTEGER,
  storage_key VARCHAR(500),                 -- storage path for orphan cleanup (set by /complete)
  complete_initiated_at TIMESTAMPTZ,        -- set by /complete to prevent double-complete race
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),     -- track last status change
  completed_at TIMESTAMPTZ,
  CONSTRAINT valid_ai_status CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'expired'))
);

CREATE INDEX IF NOT EXISTS idx_ai_gen_user ON ai_generations(user_id);
CREATE UNIQUE INDEX IF NOT EXISTS idx_ai_gen_fal_id ON ai_generations(fal_request_id);  -- UNIQUE — prevents duplicate webhook processing
CREATE INDEX IF NOT EXISTS idx_ai_gen_status ON ai_generations(status) WHERE status IN ('pending', 'processing');  -- speeds up webhook timeout cron

-- Auto-update updated_at on row changes
CREATE OR REPLACE FUNCTION update_ai_gen_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_ai_gen_updated_at
  BEFORE UPDATE ON ai_generations
  FOR EACH ROW EXECUTE FUNCTION update_ai_gen_updated_at();

-- Daily generation limits
CREATE TABLE IF NOT EXISTS ai_generation_limits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  date DATE NOT NULL DEFAULT CURRENT_DATE,
  generation_count INTEGER DEFAULT 0,
  UNIQUE(user_id, date)
);

-- Atomic global cost cap check (prevents race condition — Bug #40)
CREATE OR REPLACE FUNCTION check_global_cost_cap(
  p_daily_limit_cents INTEGER,
  p_monthly_limit_cents INTEGER,
  p_new_cost_cents INTEGER
) RETURNS BOOLEAN AS $$
DECLARE
  v_daily_total INTEGER;
  v_monthly_total INTEGER;
BEGIN
  SELECT COALESCE(SUM(cost_cents), 0) INTO v_daily_total
  FROM ai_generations
  WHERE created_at >= CURRENT_DATE
    AND status != 'failed';

  SELECT COALESCE(SUM(cost_cents), 0) INTO v_monthly_total
  FROM ai_generations
  WHERE created_at >= date_trunc('month', CURRENT_DATE)
    AND status != 'failed';

  RETURN (v_daily_total + p_new_cost_cents <= p_daily_limit_cents)
     AND (v_monthly_total + p_new_cost_cents <= p_monthly_limit_cents);
END;
$$ LANGUAGE plpgsql;

-- Feature flag
INSERT INTO feature_flags (key, name, description, category, enabled, config) VALUES
  ('ai_video_generation', 'AI Video Generation', 'Allow AI clip generation via fal.ai', 'creation', FALSE,
   '{"default_model": "kling-2.6", "max_daily_free": 1, "available_models": ["kling-2.6", "veo3-fast", "hailuo-2.3"], "max_prompt_length": 500, "daily_cost_limit_cents": 5000, "monthly_cost_limit_cents": 150000, "keyword_blocklist": ["nsfw", "nude", "gore", "violence", "blood"], "style_prompt_prefixes": {"cinematic": "cinematic film style,", "anime": "anime style,", "realistic": "photorealistic,", "abstract": "abstract art style,", "noir": "film noir style, black and white,", "retro": "retro VHS style,", "neon": "neon-lit cyberpunk style,"}}')
ON CONFLICT (key) DO NOTHING;
```

### 1B. AI Video Integration Library

**New file:** `src/lib/ai-video.ts`

Unified interface over fal.ai. Each model maps to a fal.ai model ID + config:

```typescript
interface ModelConfig {
  modelId: string;          // fal.ai model ID
  costCents: number;        // per generation
  duration: string;         // e.g. "6s", "8", "5s"
  resolution: string;
  supportsAudio: boolean;
}

const MODELS: Record<string, ModelConfig> = {
  'hailuo-2.3': {
    modelId: 'fal-ai/minimax/hailuo-2.3/pro/text-to-video',
    costCents: 49,             // flat rate per video
    duration: null,            // NOT configurable — model outputs ~6s fixed
    resolution: '1080p',       // fixed, not configurable
    supportsAudio: false,      // no native audio (TTS addon only, not used)
    supportsPortrait: false,   // CANNOT generate 9:16 — only accepts prompt + prompt_optimizer
  },
  'kling-2.6': {
    modelId: 'fal-ai/kling-video/v2.6/pro/text-to-video',  // "pro" only — Standard doesn't exist for T2V
    costCents: 35,             // $0.07/sec * 5s (audio OFF). Default w/ audio ON: $0.14 * 5 = 70
    duration: '5',             // MUST use "5" not "10" — 10s exceeds MAX_VIDEO_DURATION (8.5s)
    resolution: '720p',
    supportsAudio: true,       // native audio — BUT generate_audio defaults to true (doubles cost!)
    supportsPortrait: true,    // aspect_ratio: "9:16"
  },
  'veo3-fast': {
    modelId: 'fal-ai/veo3/fast',
    costCents: 80,             // $0.10/sec * 8s (audio OFF). Default w/ audio ON: $0.15 * 8 = 120
    duration: '8s',            // WITH 's' suffix for Veo
    resolution: '720p',
    supportsAudio: true,       // native audio — BUT generate_audio defaults to true (doubles cost!)
    supportsPortrait: true,    // aspect_ratio: "9:16"
  },
};

// IMPORTANT: generate_audio defaults to TRUE on Kling and Veo.
// If not explicitly set to false, costs DOUBLE.
// costCents above assumes generate_audio: false.
```

Core functions:
- `startGeneration(prompt, model, style, genre)` → calls `buildInput(model, prompt, style)`, submits to fal.ai Queue API with webhook, returns `{ requestId }`
- `checkStatus(requestId)` → reads our DB (webhook updates it), returns `{ status, videoUrl, error, stage }`
- `getModelDuration(model)` → returns `MODEL_DURATION_SECONDS[model]` for `duration_seconds` on clip insert

**fal.ai path:** Queue API at `https://queue.fal.run/{modelId}` with webhook

`downloadAndStore` removed per bug fix #1 — client uploads directly via signed URL.

**NPM package (must be installed — not in package.json):**
- `@fal-ai/client` (fal.ai SDK) — `npm install @fal-ai/client`

### 1C. Validation Schemas

**Modify:** `src/lib/validations.ts` — add `AIGenerateSchema`:
- `prompt`: string, 10-500 chars, trimmed
- `model`: enum `['hailuo-2.3', 'kling-2.6', 'veo3-fast']`, default `'hailuo-2.3'`
- `style`: optional enum `['cinematic', 'anime', 'realistic', 'abstract', 'noir', 'retro', 'neon']`
- `genre`: optional string

### 1D. Rate Limit

**Modify:** `src/lib/rate-limit.ts`:
- Add `ai_generate: { requests: 3, window: '1m' }` to `RATE_LIMITS`
- Add `ai_status: { requests: 30, window: '1m' }` to `RATE_LIMITS`
- Add `'ai_generate'` to `CRITICAL_RATE_LIMIT_TYPES` (fail-closed on Redis outage — AI costs real money)

### 1E. Types

**Modify:** `src/types/index.ts` — add `AIGeneration`, `AIModel`, `AIStyle` interfaces

---

## Phase 2: API Routes

### 2A. `POST /api/ai/generate`

**New file:** `src/app/api/ai/generate/route.ts`

1. Rate limit (`ai_generate` — must be in `CRITICAL_RATE_LIMIT_TYPES` for fail-closed on Redis outage)
2. Auth required (NextAuth session) + CSRF check
3. **Check user is not banned** (`is_banned` check on users table — not currently in JWT)
4. Check `ai_video_generation` feature flag enabled (server-side `.maybeSingle()` pattern)
5. Validate body with `AIGenerateSchema` (Zod `.strict()` to reject extra fields)
6. Sanitize prompt: `sanitizeText()` + Unicode normalization (NFKD + strip zero-width chars) + keyword blocklist
7. Atomic daily limit increment via `check_and_reserve_generation()` PG function
8. Global cost cap check (atomic — `check_global_cost_cap()` PG function to prevent race)
9. **Insert `ai_generations` row FIRST** (status: `pending`, placeholder `fal_request_id`)
10. Call `startGeneration()` → get fal.ai `requestId` (10s timeout)
11. Update `ai_generations` with real `fal_request_id`
12. If fal.ai call fails (402/429/500/timeout): mark row as `failed`, but do **NOT** decrement daily limit (count represents attempts, prevents gaming)
13. Return `{ ok: true, generationId, status: 'pending', estimatedSeconds: 120 }`

> **Why insert DB row before fal.ai call (steps 9-11):** If fal.ai succeeds but DB insert fails, the generation runs on fal.ai with no tracking row. The webhook fires but has no `fal_request_id` to match — generation is silently lost, money wasted. Inserting first ensures tracking exists even if fal.ai fails.
>
> **Why NOT decrement on fal.ai failure (step 12):** If we decremented on failure, an attacker could intentionally cause failures (e.g., saturate the 2-task concurrent limit) and get unlimited retry attempts. Counting attempts, not successes, prevents this.

### 2B. `GET /api/ai/status/[id]`

**New file:** `src/app/api/ai/status/[id]/route.ts`

1. Auth required + rate limit (`ai_status`: 30 req/min)
2. Look up `ai_generations` by `id`, verify user owns it (return 404 for not-found AND not-owned)
3. Read status from our DB only — **never call fal.ai from this endpoint** (webhook updates DB; cron handles fallback)
4. Return `{ status, videoUrl, error, stage }` — **never expose `fal_request_id` or `cost_cents`**
   - `stage` maps to frontend progress indicator: `"queued"` | `"generating"` | `"rendering"` | `"ready"` | `"failed"`
   - DB `pending` → stage `"queued"`, DB `processing` → stage `"generating"`, DB `completed` → stage `"ready"`

### 2C. `POST /api/ai/complete`

**New file:** `src/app/api/ai/complete/route.ts`

> Updated to match Revised Architecture (two-step: complete returns URLs, register saves metadata).

1. Auth + CSRF + rate limit
2. Look up generation, verify user owns it, status is `completed`
3. Check `completed_at` age — if > 7 days, return 410 "Video expired, please regenerate"
4. **Check active season exists** (`.limit(1)` + `data?.[0]`, NOT `.single()`) — return 400 "No active season" if none
5. **Check active slot exists** (`.in('status', ['voting', 'waiting_for_clips'])`) — return 400 "No available slot" if none
6. Atomically mark generation as `complete_initiated` (`UPDATE ... SET complete_initiated_at = NOW() WHERE complete_initiated_at IS NULL RETURNING *` — prevents double-complete race)
7. Check `r2_storage` feature flag (same `.maybeSingle()` pattern as `signed-url/route.ts`)
8. Generate storage key: `clip_{timestamp}_{random}.mp4` (same pattern as existing signed-url)
9. Call `getSignedUploadUrl(filename, 'video/mp4', provider)` from `src/lib/storage/`
10. **Construct public URL server-side** from storage key (never accept from client)
11. Store `storage_key` on the `ai_generations` row (for orphan cleanup)
12. Return `{ falVideoUrl, signedUploadUrl, storageKey }` — **no publicUrl** (constructed server-side at register time)

> **Client then:** `fetch(falVideoUrl)` → `PUT` to `signedUploadUrl` → calls `/api/ai/register`

### 2D. `POST /api/ai/register`

**New file:** `src/app/api/ai/register/route.ts`

> Mirrors `upload/register/route.ts` logic exactly. Must replicate:

1. Auth + CSRF + rate limit
2. Validate body: `{ generationId, genre, title }` (title required — **no publicUrl from client**)
3. Check `ai_video_generation` feature flag (server-side)
4. Check user is not banned (`is_banned` check on users table)
5. Look up generation, verify user owns it, status is `completed`, `clip_id IS NULL` (double-submit guard), `storage_key IS NOT NULL` (must have called /complete first)
6. Get active season: `.limit(1)` + `data?.[0]` (NOT `.single()`)
7. Re-verify active slot: `.in('status', ['voting', 'waiting_for_clips'])` + `.limit(1)` — **must re-check at register time**, not rely on complete's check
8. **Construct public URL server-side** from `storage_key` stored on the generation row (same pattern as existing `signed-url/route.ts`)
9. Insert `tournament_clips` row:
   - `season_id`, `slot_position` from slot lookup
   - `track_id: 'track-main'` (hardcoded, matches existing register)
   - `genre: genre.toUpperCase()` (existing register stores genre UPPERCASE)
   - `title`, `description` (title from request, description = prompt or from request)
   - `username`, `avatar_url` (from user profile lookup by email)
   - `uploader_key` (SHA256 device fingerprint, same as `getVoterKey()`)
   - `duration_seconds` (model-specific: Hailuo=6, Kling=5, Veo=8 — derive from `MODELS[model].duration` or use fixed lookup)
   - `status: 'pending'`
   - `is_ai_generated: true`, `ai_prompt`, `ai_model`, `ai_generation_id`, `ai_style`
10. Start voting timer if first clip in slot (same logic as `register/route.ts` lines 178-199)
11. Update `ai_generations.clip_id`
12. Audit log: `logAdminAction` or new `logUserAction` with action `'ai_register'`
13. Return `{ ok: true, clipId }`

> **Title/description for AI clips:** Regular uploads require `title` (1-100 chars). AI clips should also provide a title. Options: (a) auto-generate from first 100 chars of prompt, (b) add title input in the "Submit to Tournament" step UI. **Recommendation:** Auto-generate from prompt, allow user to edit before submitting.

### 2E. `POST /api/ai/webhook`

**New file:** `src/app/api/ai/webhook/route.ts`

1. Rate limit: 100 req/min (by IP)
2. Reject non-POST methods
3. Verify ED25519 signature (see Webhook Verification section — uses 4 headers + constructed message)
4. Parse verified body as JSON
5. Look up generation by `fal_request_id`
6. **Idempotency guard:** Only update if current status is `pending` or `processing` (reject if `completed`, `failed`, `expired`)
7. If webhook status is `OK`:
   - Extract `payload.video.url` — if missing, mark as `failed`
   - Validate video URL hostname matches `*.fal.media` or `*.fal.ai`
   - Update generation: `status: 'completed'`, `video_url`, `completed_at`
8. If webhook status is `ERROR`:
   - Update generation: `status: 'failed'`, `error_message`
9. Return 200 always (prevents fal.ai retries — use cron as fallback for DB failures)

### 2F. `GET /api/ai/history`

**New file:** `src/app/api/ai/history/route.ts`

Auth required. Returns user's last 20 generations ordered by `created_at DESC`. Paginated using `validatePagination()` pattern.

---

## Phase 3: Upload Page — AI Tab

**Modify:** `src/app/upload/page.tsx`

Changes:
1. Add `useFeature('ai_video_generation')` check
2. Add tab toggle at Step 1: **"Upload Video" | "AI Generate"** (hidden when flag off)
3. When AI tab selected, render `<AIGeneratePanel />` instead of file drop zone
4. Genre from Step 2 passed to panel as `preselectedGenre`

### AIGeneratePanel Component

**New file:** `src/components/AIGeneratePanel.tsx`

```
Props: { preselectedGenre?, onComplete?, compact? }
```

UI:
1. **Prompt textarea** — 500 char limit, placeholder suggestions, character counter
2. **Style pills** — grid of style options (cinematic, anime, realistic, etc.)
3. **Genre auto-select** — from parent or manual pick
4. **Generate button** — gradient, shows daily limit ("2 of 3 remaining")
5. **Progress indicator** — animated bar with stages (Submitting → Generating → Finalizing → Ready)
6. **Video preview** — when complete, show in 9:16 player (same as upload preview)
7. **Submit to Tournament** button — calls `/api/ai/complete`
8. **Regenerate** button — start over with same prompt

Polling: `useEffect` with `setInterval(3000)` checking `/api/ai/status/[id]`.
- **Auto-resume on page load:** Check `localStorage` for `ai_active_generation_id`. If found and status is `pending`/`processing`, resume polling immediately. Clear on completion/failure/expiry.
- **Queued stage:** Map `IN_QUEUE` fal.ai status → "Queued" in progress indicator (between Submitting and Generating).

Uses `useCsrf()` for POST requests (existing pattern).

---

## Phase 4: Dedicated `/create` Page

**New file:** `src/app/create/page.tsx`

Full-screen AI creation experience:
1. **Prompt builder** — large textarea with suggestion chips ("epic space battle", "noir detective", "cute animation")
2. **Style cards** — visual grid with style previews
3. **Model picker** — cards showing model name, provider badge (fal.ai/OpenAI), cost, quality tier
4. **Genre selector** — reuse existing genre grid
5. **`<AIGeneratePanel compact={false} />`** — full generation experience
6. **Generation history** — grid of past generations with status, thumbnails, retry buttons

### Hook

**New file:** `src/hooks/useAIGenerations.ts`

React Query wrapper for `/api/ai/history`:
```typescript
useQuery({ queryKey: ['ai-generations'], queryFn: ..., staleTime: 30_000 })
```

### Navigation

**Modify:** `src/components/BottomNavigation.tsx` — add "Create" item with `Sparkles` icon, conditionally shown when `ai_video_generation` flag enabled.

---

## Phase 5: Admin & Safety

### 5A. Admin Dashboard

**Modify:** `src/app/admin/page.tsx`

- Add `is_ai_generated`, `ai_prompt`, `ai_model` to clip interface
- Show "AI" badge on AI-generated clips in the clip list
- Show prompt text in clip detail/expand view
- Add "AI Only" filter option

### 5B. Admin Clips API

**Modify:** `src/app/api/admin/clips/route.ts`

- Add `is_ai_generated, ai_prompt, ai_model` to `.select()`
- Add `?ai_only=true` query parameter support

### 5C. Cost Tracking

**New file:** `src/app/api/admin/ai-stats/route.ts`

Admin-only endpoint returning:
- Generations today / this week / this month
- Total cost (sum `cost_cents`)
- Success/failure ratio
- Top users by generation count
- Cost breakdown by model

### 5D. Prompt Safety

- Server-side keyword blocklist before sending to fal.ai (reuse `sanitizeText` pattern)
- All prompts stored in DB for admin review
- AI clips go through same admin approval flow as manual uploads

---

## Dependencies & Parallelization

```
Phase 1 (all parallel) ─── Phase 2 (all parallel) ─── Phase 3 (upload tab)
                                                    └── Phase 4 (/create page)
                                                    └── Phase 5 (admin, parallel with 3/4)
```

- Phase 3 component can start with mocked API before Phase 2 is done
- Phase 5 admin changes are independent of Phase 3/4

---

## Cost Control

| Protection | How |
|------------|-----|
| Daily per-user limit | `ai_generation_limits` table, checked server-side before every generation |
| Rate limiting | 3 requests/minute per user at API level |
| Feature flag | `ai_video_generation` — instant kill switch |
| Admin approval | AI clips get `status: pending`, same as manual uploads |
| Cost tracking | `cost_cents` on every generation, admin dashboard shows totals |
| No client-side keys | `FAL_KEY` is server-only env var |

---

## Env Vars

```
FAL_KEY=fal-xxxxxxxxxxxxxxxx        # fal.ai API key (server-only) — single key for all models
```

> Note: No OpenAI API key needed — all models run through fal.ai.

---

## Bug Analysis — Issues Found & Fixes

### CRITICAL (5)

**1. Server OOM: `downloadAndStore()` downloads video on Vercel serverless**
The plan proposes downloading video from fal.ai on the server and re-uploading to storage. Vercel has 256MB-1GB memory and 10-60s timeout. A 30MB video = ~60MB peak memory (fetch buffer + Node.js Buffer). This contradicts the existing signed-URL pattern where the browser uploads directly.

**FIX**: Don't download on server. Instead: (a) `/api/ai/complete` generates a signed upload URL via existing `src/lib/storage/`, (b) returns both the fal.ai video URL and the signed upload URL to the client, (c) client fetches from fal.ai and PUTs to storage directly (same pattern as regular upload). Server only registers the clip metadata.

**2. Multi-active-season crash copied into `/api/ai/complete`**
Plan says "same pattern as upload/register" which uses `.single()` — crashes with multiple active seasons.

**FIX**: Use `.limit(1)` without `.single()`. Access `data?.[0]` instead.

**3. Race condition: daily limit checked BEFORE fal.ai call, incremented AFTER**
Two concurrent requests both read `count=4` (limit 5), both pass, both call fal.ai = 6 generations.

**FIX**: Use atomic upsert-with-check BEFORE calling fal.ai:
```sql
INSERT INTO ai_generation_limits (user_id, date, generation_count)
VALUES ($1, CURRENT_DATE, 1)
ON CONFLICT (user_id, date)
DO UPDATE SET generation_count = generation_count + 1
WHERE ai_generation_limits.generation_count < $limit
RETURNING generation_count;
```
Zero rows returned = limit reached. If fal.ai fails afterward, decrement.

**4. No CSRF protection on AI endpoints**
Each generation costs real money. Cross-origin POST could drain budget. The `requireCsrf()` function exists in `src/lib/csrf.ts` but isn't referenced.

**FIX**: Add `requireCsrf(request)` to `/api/ai/generate` and `/api/ai/complete`.

**5. Daily limit timezone mismatch**
`CURRENT_DATE` is UTC on Vercel. Users in different timezones could get extra generations around midnight.

**FIX**: Explicitly use UTC everywhere. Use `getStartOfTodayUTC()` from `src/lib/api-utils.ts` for queries. Document UTC as the standard.

### HIGH (8)

**6. URL validation rejects fal.ai URLs**
Existing `RegisterClipSchema` allowlists `*.supabase.co`, `*.r2.dev`, `cdn.aimoviez.app`. With the client-side upload fix (#1), the final URL IS on our storage — but validate it anyway.

**FIX**: In `/api/ai/complete`, construct the public URL server-side (never from client input) and validate against the allowlist.

**7. Feature flag must be checked server-side independently**
Frontend `useFeature()` check is bypassable via direct API call.

**FIX**: Each AI API route queries `feature_flags` table directly using service role client (same pattern as `upload/signed-url` lines 79-83).

**8. SSRF risk downloading from fal.ai**
If `video_url` is manipulated, server-side `fetch()` could hit internal services.

**FIX**: With client-side upload fix (#1), server never fetches the URL. If server-side download is ever needed, validate hostname matches `*.fal.media` or `*.fal.ai` and use `sanitizeUrl()` from `src/lib/sanitize.ts`.

**9. Orphaned storage files on partial failure**
Upload succeeds but clip insertion fails → orphaned file in storage.

**FIX**: Check season/slot existence BEFORE returning signed URL. If clip insert fails, client doesn't upload. Add cleanup job for files with no matching clip.

**10. No prompt size limit on DB column**
`ai_prompt TEXT` has no limit. 100KB prompt bloats DB + API responses.

**FIX**: Use `VARCHAR(2000)`. Zod validates to 500 chars (plan already says this), but DB constraint adds defense in depth.

**11. Polling-only architecture overwhelms fal.ai**
Each user poll = call to fal.ai. 100 users * every 3s = 2000 req/min to fal.ai.

**FIX**: Use fal.ai webhooks. Add `POST /api/ai/webhook` (unauthenticated, verify shared secret). fal.ai POSTs completion → updates DB. Frontend polls only our DB (cheap). Fall back to fal.ai polling only if webhook doesn't fire within timeout.

**12. No global cost cap**
Per-user daily limits exist, but total platform spend = `daily_limit * active_users * cost`.

**FIX**: Add `daily_cost_limit_cents` and `monthly_cost_limit_cents` to feature flag config. Check `SUM(cost_cents)` before allowing generation.

**13. Missing RLS on new tables**
`ai_generations` and `ai_generation_limits` need RLS. Without it, anyone with the public anon key can read all prompts and modify limits.

**FIX**: Enable RLS. Add `FOR SELECT USING (user_id = auth.uid())` on both tables. Service role bypasses RLS for admin/server operations.

### MEDIUM (9)

14. **Genre mismatch**: Frontend `'scifi'` vs validation `'sci-fi'`. Fix: align both.
15. **No audit logging for AI actions**: Add `'ai_generate' | 'ai_complete'` to `AuditAction` type.
16. **AI clips don't trigger voting timer**: Extract timer logic from `upload/register` into shared utility, call from `ai/complete` too.
17. **Status endpoint info leak**: Return 404 for both not-found and not-owned. Never expose `fal_request_id`.
18. **Config schema not validated**: Parse feature flag config with Zod at read time.
19. **History endpoint lacks pagination**: Use existing `validatePagination()` pattern.
20. **`completed_at` never set**: Set it in webhook handler or status polling when transition to `completed`.
21. **No `ON DELETE SET NULL`** on `ai_generations.clip_id` FK — would block clip deletion.
22. **`ai_style` needs validation**: Define enum, validate with Zod, sanitize.

### ADDITIONAL BUGS — Round 2 (found in first re-analysis)

**23. CRITICAL: Wrong fal.ai webhook signature header**
Plan originally used `X-Fal-Signature` — the correct header is `X-Fal-Webhook-Signature`. Would silently reject all legitimate webhooks. **FIXED inline above.**

**24. CRITICAL: Wrong fal.ai JWKS endpoint URL**
Plan originally used `https://queue.fal.run/.well-known/jwks.json` — the correct URL is `https://rest.alpha.fal.ai/.well-known/jwks.json`. Would break all webhook verification. **FIXED inline above.**

**25. HIGH: Sora 2 Pro has different durations than Sora 2**
Sora 2 supports 4, 8, 12 seconds. Sora 2 Pro supports 10, 15, 25 seconds — NOT the same. Requesting `duration: 8` from Sora 2 Pro would fail with API error. **FIXED inline above** — use 10s for Pro tier. *(Note: Sora removed from plan — kept for reference.)*

**26. HIGH: Sora API does support webhooks**
Plan originally claimed Sora uses polling only. OpenAI Sora API does support webhooks, though reliability has been reported as inconsistent. **FIXED inline above** — use webhook as primary, polling as fallback. *(Note: Sora removed from plan — kept for reference.)*

**27. MEDIUM: Veo cost is variable, not fixed**
Pricing: $0.10/sec (no audio) to $0.15/sec (with audio) on Fast tier. For 8 seconds: $0.80 (no audio) to $1.20 (with audio). **FIXED inline above** — show range in provider table and cost projections.

**28. MEDIUM: OpenAI Tier 2 access may require $50, not $10**
Some sources indicate $50 minimum credit purchase for Tier 2 API access. *(No longer relevant — Sora removed from plan.)*

**29. LOW: NPM dependencies not in package.json**
`@fal-ai/client` is not currently installed. **FIXED inline above** — added explicit install command.

### ADDITIONAL BUGS — Round 3 (found in deep re-analysis)

**30. CRITICAL: Kling 2.6 Standard text-to-video doesn't exist on fal.ai**
The model ID `fal-ai/kling-video/v2.6/standard/text-to-video` does NOT exist. Only `fal-ai/kling-video/v2.6/pro/text-to-video` (Pro tier) is available for text-to-video. The Standard tier exists only for image-to-video. Using the wrong model ID would cause every Kling generation to fail with a 404. **FIXED inline above** — changed to Pro tier.

**31. HIGH: Duration format differs between models**
Each model uses a different duration format:
- Hailuo: `"6"` (no `s` suffix, or omit entirely for default)
- Kling: `"5"` or `"10"` (string, no `s` suffix)
- Veo 3: `"8s"` (string WITH `s` suffix)
The original ModelConfig used inconsistent formats. Passing `"5s"` to Kling or `"8"` without `s` to Veo would cause API errors. **FIXED inline above** — model-specific `buildInput()` function handles format differences.

**32. HIGH: Hailuo does NOT support `aspect_ratio` parameter**
Hailuo's API does not accept `aspect_ratio`, `video_size`, or any portrait control. Output is always landscape. **FIXED inline above** — documented as limitation; `buildInput()` sends only `{ prompt, prompt_optimizer }` for Hailuo.

**33. HIGH: Stale OPENAI_API_KEY in Env Vars section**
The Env Vars section still listed `OPENAI_API_KEY` despite removing Sora from the plan. Would confuse implementers. **FIXED inline above** — removed.

**34. HIGH: No webhook timeout/fallback mechanism**
If fal.ai webhook fails to deliver (network issue, deployment gap), generations stay stuck in `pending`/`processing` forever with no recovery path. **FIXED inline above** — added cron job `ai-generation-timeout` that polls fal.ai for stuck generations every 5 minutes and auto-fails after 30 minutes.

**35. MEDIUM: Database schema missing UNIQUE on fal_request_id**
Without UNIQUE constraint, duplicate webhook deliveries could create duplicate rows or update wrong rows. **FIXED inline above** — changed to `CREATE UNIQUE INDEX`.

**36. MEDIUM: Database schema missing updated_at column**
No way to track when a generation's status last changed, making timeout detection unreliable. **FIXED inline above** — added `updated_at` column with auto-update trigger.

**37. MEDIUM: Database schema missing status index**
Cron job and webhook queries filter by `status IN ('pending', 'processing')` — without an index, this scans the full table. **FIXED inline above** — added partial index on status.

**38. MEDIUM: clip_id FK missing ON DELETE SET NULL**
Without `ON DELETE SET NULL`, deleting a tournament clip that was AI-generated would fail with a foreign key violation, blocking admin operations. **FIXED inline above** — added `ON DELETE SET NULL`.

**39. MEDIUM: Hailuo audio capability incorrectly assessed**
Hailuo 2.3 does NOT have native audio synthesis. It has a separate TTS (text-to-speech) addon that is not integrated into video generation. The provider table correctly showed "No" but the code comments were ambiguous. **CLARIFIED inline above** — explicitly documented that Hailuo has no usable audio for video.

**40. MEDIUM: Global cost cap has race condition**
The `SUM(cost_cents)` check before allowing generation has the same race condition as the daily limit — two concurrent requests could both pass. **Documented in security gaps section** — use atomic PG function or `SELECT ... FOR UPDATE`.

**41. MEDIUM: Genre mismatch is an integration blocker**
`validations.ts` uses `'sci-fi'` but upload page uses `'scifi'`. AI generation would store one format while the rest of the app uses another, causing filtering/matching failures. **Documented above** — must align before implementation.

**42. LOW: No per-model daily limits**
A user could burn all their daily budget on the most expensive model (Veo). **Documented in security gaps** — add `max_daily_per_model` config.

**43. LOW: Consider Veo 3.1 Fast instead of Veo 3 Fast**
`fal-ai/veo3.1/fast` is a newer model at the same price tier with potentially better quality. **NOTED inline** — consider upgrading model ID.

### ADDITIONAL BUGS — Round 4 (found in deepest re-analysis)

**44. CRITICAL: Hailuo does NOT accept `video_size` parameter**
The plan's `buildInput()` for Hailuo sent `{ prompt, video_size: { width: 720, height: 1280 } }`. In reality, Hailuo 2.3 Pro ONLY accepts `prompt` and `prompt_optimizer` — no other parameters exist. Sending `video_size` would either error or be silently ignored (landscape output). **FIXED inline above** — `buildInput()` now sends `{ prompt, prompt_optimizer: true }` only.

**45. CRITICAL: Hailuo has NO configurable duration parameter**
The plan had `duration: '6'` in the ModelConfig. Hailuo 2.3 Pro does not expose a duration parameter at all — the model outputs ~6 seconds at fixed duration. The older Hailuo 02 Standard had `duration` but 2.3 Pro does not. **FIXED inline above** — `duration: null` in config.

**46. CRITICAL: Hailuo CANNOT generate portrait (9:16) video**
No `aspect_ratio` or `video_size` parameter exists. Output is always landscape. For a vertical-video tournament app, this is a significant limitation. **DOCUMENTED inline** — recommend excluding Hailuo or accepting landscape-only tier.

**47. CRITICAL: Webhook verification code was completely wrong (6 errors)**
The previous verification code: (1) only checked 1 of 4 required headers, (2) verified signature against raw body instead of constructed message, (3) used base64 instead of hex encoding, (4) had no timestamp validation, (5) did not construct the `requestId\nuserId\ntimestamp\nsha256hex(body)` message, (6) had no replay attack protection. **FIXED inline above** — completely rewritten with correct 4-header + constructed message + hex + timestamp verification using native Node.js crypto.

**48. CRITICAL: 10-second Kling clips fail existing validation**
`MAX_VIDEO_DURATION` in `validations.ts` is 8.5 seconds. A 10-second Kling clip would be rejected by `RegisterClipSchema`. **FIXED inline above** — restrict Kling to `"5"` duration only.

**49. HIGH: `generate_audio` defaults to `true` on Kling and Veo — doubles cost**
Both Kling ($0.14/sec) and Veo ($0.15/sec) have `generate_audio` defaulting to `true`. The plan's cost estimates assumed audio OFF ($0.07/sec Kling, $0.10/sec Veo). Without explicitly passing `generate_audio: false`, actual costs double. **FIXED inline above** — `buildInput()` now explicitly passes `generate_audio: enableAudio`.

**50. HIGH: Phase 2C described the OLD flow (server downloads video)**
Phase 2C still said "Download video from fal.ai URL" and "Upload to Supabase/R2" — contradicting the Revised Architecture where the client handles this. **FIXED inline above** — Phase 2C rewritten to return signed URL only. New Phase 2D (register) and Phase 2E (webhook) added.

**51. HIGH: fal.ai call happened before DB insert (lost generation risk)**
If fal.ai call succeeds but DB insert fails, the generation runs with no tracking row — webhook has nothing to match. **FIXED inline above** — DB row inserted BEFORE fal.ai call.

**52. HIGH: Late webhook could resurrect failed/expired generations**
Webhook handler only checked `status != 'completed'`. A late webhook for a failed (30min timeout) or expired (24h cleanup) generation would update it back to `completed`. **FIXED inline above** — webhook only updates if status IN (`pending`, `processing`).

**53. HIGH: No `is_banned` check in AI endpoints**
Banned users could still generate AI videos until their JWT expired. Neither the existing upload flow nor the AI plan checked `is_banned`. **FIXED inline above** — banned check added to all AI endpoints.

**54. HIGH: `ai_generate` not in `CRITICAL_RATE_LIMIT_TYPES`**
When Redis is down, non-critical rate limits fall back to per-instance in-memory limiting — easily bypassed on Vercel (new instance = new counter). AI generation costs real money and should fail-closed. **FIXED inline above** — noted in Phase 2A.

**55. HIGH: Missing title/description for AI clips entering tournament**
Existing `RegisterClipSchema` requires `title` (1-100 chars). AI flow had no mechanism for providing a title. **FIXED inline above** — auto-generate from prompt, allow user to edit.

**56. HIGH: `track_id: 'track-main'` not mentioned in plan**
Existing `register/route.ts` hardcodes `track_id: 'track-main'` in clip insertion. Omitting this would cause the clip insert to fail or use a NULL track_id. **FIXED inline above** — added to Phase 2D register steps.

**57. HIGH: Genre stored as UPPERCASE in DB**
Existing `register/route.ts` calls `genre.toUpperCase()` before DB insert. AI register must do the same. **FIXED inline above** — added to Phase 2D.

**58. HIGH: Slot must be re-verified at register time (not complete time)**
Between `/api/ai/complete` (returns URLs) and `/api/ai/register` (saves clip), the active slot could change — `auto-advance` cron could lock the slot and advance to the next one. **FIXED inline above** — Phase 2D re-verifies slot at register time.

**59. HIGH: fal.ai CDN CORS may block client-side fetch**
The plan has the client `fetch(falVideoUrl)` from the browser to download the AI video. If `*.fal.media` doesn't serve `Access-Control-Allow-Origin: *`, the fetch will fail due to CORS. **Must verify before implementation.** Fallback: lightweight streaming proxy server-side.

**60. MEDIUM: Triple genre mismatch across codebase (pre-existing, blocks integration)**
Four different genre lists exist: `types/index.ts` (4 genres), `validations.ts` (8 genres with `sci-fi`), `upload/page.tsx` (8 genres with `scifi` + `other`), `admin/page.tsx` (uses `scifi`). Additionally, `VotingClip.genre` type only has 4 UPPERCASE values. **Must fix before AI implementation.**

**61. MEDIUM: `DbClip` type is severely outdated**
Missing `season_id`, `slot_position`, `genre`, `title`, `description`, `hype_score`, `uploader_key`, `duration_seconds`. Status enum is wrong (`'approved'` vs actual `'active'`). AI types would compound the drift.

**62. MEDIUM: Audit logging is admin-only (`logAdminAction`)**
AI actions are user actions, but the logging function is named and designed for admin actions. Either create `logUserAction()` or accept the semantic mismatch. Also needs `'ai_generation'` resource type.

**63. MEDIUM: No distributed lock for timeout cron**
Existing `auto-advance` cron uses `cron_locks` table for distributed locking. The AI timeout cron does not. Concurrent execution could poll fal.ai for the same stale generations, wasting API calls.

**64. MEDIUM: Auto-expire SQL has no cron job definition**
The plan provides SQL to expire old generations but says "Run daily" without defining where/how. Should be integrated into the `ai-generation-timeout` cron.

**65. MEDIUM: No `release_generation_reservation` function**
Bug fix #3 says "If fal.ai fails afterward, decrement." But no `release_generation_reservation()` PG function is defined. (Per bug #49's fix, we now do NOT decrement on failure — count represents attempts.)

**66. MEDIUM: Zod v4 in use (not v3)**
`package.json` has Zod v4.1.13. `AIGenerateSchema` must follow v4 patterns. Notably, v4 uses `result.error.issues` not `result.error.errors`.

**67. LOW: `requireCsrf()` is never called anywhere in the existing app**
CSRF double-submit cookie is defined and the client sends the header, but no server-side route validates it. Adding it only to AI endpoints would be inconsistent. Consider adding to all mutation routes.

**68. LOW: `useFeature` hook returns untyped config**
AI frontend needs typed access to `max_daily_free`, `available_models`, etc. Should define `AIVideoConfig` interface.

### ADDITIONAL BUGS — Round 5 (found in end-to-end flow simulation)

**69. CRITICAL: fal.ai CDN CORS unverified — entire client-upload flow may be broken**
The plan's client-side upload flow requires `fetch(falVideoUrl)` from the browser. If `*.fal.media` doesn't serve `Access-Control-Allow-Origin: *`, the fetch fails. No alternative flow is defined. **FIXED inline above** — added prerequisite check and streaming proxy fallback.

**70. CRITICAL: `requireCsrf()` is never enforced anywhere in the existing codebase**
The `csrf.ts` module exports `requireCsrf()` and `useCsrf()` hook sends the header, but NO API route calls `requireCsrf()`. Adding it only to AI endpoints creates inconsistency and false sense of security. Pre-existing vulnerability. **Documented** — consider adding to all mutation routes as part of AI implementation.

**71. HIGH: Feature flag config has `default_model: "hailuo-2.3"` — generates landscape in portrait app**
Hailuo cannot generate 9:16 video. If a user accepts the default model, they get landscape output that doesn't fit the vertical-video tournament format. **FIXED inline above** — changed default to `kling-2.6`.

**72. HIGH: Cron uses model key (`kling-2.6`) not fal.ai model ID — fallback polling is broken**
`fal.queue.status()` requires the fal.ai model ID (e.g., `fal-ai/kling-video/v2.6/pro/text-to-video`), not the config key. The cron passes `gen.model` (the key) directly. **FIXED inline above** — added model key → model ID mapping in cron.

**73. HIGH: Style parameter does nothing — no prompt engineering implemented**
The `style` field was stored but never affected the actual prompt sent to fal.ai. A user selecting "cinematic" or "noir" would get identical output to no style. **FIXED inline above** — added `STYLE_PREFIXES` mapping in `buildInput()` and `style_prompt_prefixes` config in feature flag.

**74. HIGH: No `negative_prompt` for Kling/Veo reduces output quality**
Both Kling and Veo support `negative_prompt` to reduce common artifacts (blur, watermarks, text). Not using it wastes an easy quality improvement. **FIXED inline above** — added `DEFAULT_NEGATIVE_PROMPTS` in `buildInput()`.

**75. HIGH: No storage cleanup for orphaned files**
If a user calls `/complete` (gets signed URL, uploads) but never calls `/register`, the file sits in storage forever with no cleanup. **FIXED inline above** — cron step 5 cleans up storage files where `storage_key IS NOT NULL` and status is `failed`/`expired`.

**76. HIGH: No season/slot check in `/complete` endpoint**
User could call `/complete`, get a signed URL, upload the file, then discover at `/register` time that no active slot exists. Wastes storage space and user effort. **FIXED inline above** — added season/slot check to `/complete` steps 4-5.

**77. HIGH: `publicUrl` accepted from client body in `/register` contradicts server-side URL construction**
Phase 2D's body validation included `publicUrl` from the client, but bug #6 says to construct URLs server-side. An attacker could register a clip pointing to an arbitrary URL. **FIXED inline above** — removed `publicUrl` from body params; constructed from `storage_key` server-side.

**78. HIGH: `duration_seconds` not set for AI clips**
Existing `tournament_clips` has `duration_seconds` column. Regular uploads presumably set it from video metadata. AI clips have known fixed durations per model but the plan never set this field, potentially causing NULL in the tournament UI. **FIXED inline above** — added `MODEL_DURATION_SECONDS` lookup and `duration_seconds` to clip insert.

**79. MEDIUM: Auto-expire SQL defined but not wired to cron**
The plan provided `UPDATE ... SET status = 'expired'` SQL in the "Auto-Expire" section but said "Run daily" without defining how. Not integrated into any cron job. **FIXED inline above** — integrated into `ai-generation-timeout` cron step 4.

**80. MEDIUM: Global cost cap has race condition with no atomic function**
Bug #40 documented the race but no fix was provided. Two concurrent requests could both pass the `SUM(cost_cents)` check. **FIXED inline above** — added `check_global_cost_cap()` PG function to migration.

**81. MEDIUM: No polling resume on page reload**
If user navigates away and returns while generation is running, there's no mechanism to resume polling. The generation would appear lost from the user's perspective. **FIXED inline above** — `localStorage` persistence of `ai_active_generation_id` with auto-resume.

**82. MEDIUM: IN_QUEUE status not mapped to frontend stage**
fal.ai returns `IN_QUEUE` before `IN_PROGRESS`. The plan's progress stages didn't account for this intermediate state — UI would show "Generating" when actually still queued. **FIXED inline above** — added "Queued" stage mapping.

**83. MEDIUM: Cron doesn't distinguish IN_QUEUE from IN_PROGRESS**
A generation in `IN_QUEUE` for 10 minutes is normal (fal.ai is busy). A generation in `IN_PROGRESS` for 10 minutes may be stuck. The cron treated both the same, potentially auto-failing queued jobs too early. **FIXED inline above** — cron now updates IN_QUEUE to `processing` and continues waiting.

**84. MEDIUM: Status endpoint returns raw DB status, not UI-friendly stage**
Frontend needs to map `pending`/`processing`/`completed`/`failed` to progress stages. This mapping should be server-side for consistency. **FIXED inline above** — added `stage` field to status response.

**85. MEDIUM: No model-specific duration available at register time**
Register needs `duration_seconds` but the generation row only stores the model key. **FIXED inline above** — added `MODEL_DURATION_SECONDS` export from `ai-video.ts`.

**86. LOW: `available_models` order in feature flag still lists hailuo first**
UI typically renders model picker from the `available_models` array. Hailuo first suggests it's the recommended choice. **FIXED inline above** — reordered to `["kling-2.6", "veo3-fast", "hailuo-2.3"]`.

**87. LOW: No streaming proxy fallback defined for CORS failure**
If fal.ai CDN doesn't support CORS, the plan says "need streaming proxy" but provides no implementation. **DOCUMENTED in prerequisites** — lightweight `/api/ai/proxy-download` that streams without buffering.

---

## Revised Architecture (incorporating fixes)

```
User → Prompt → POST /api/ai/generate
  ↓ Rate limit (CRITICAL — fail-closed if Redis down)
  ↓ Auth + CSRF check + banned check
  ↓ Feature flag check (server-side)
  ↓ Sanitize prompt (NFKD normalize + strip zero-width + blocklist)
  ↓ Atomic daily limit increment (PG function)
  ↓ Global cost cap check (atomic — check_global_cost_cap() PG function)
  ↓ Insert ai_generations row FIRST (status: pending)
  ↓ buildInput(model, prompt, style) — prepends style prefix, adds negative_prompt
  ↓ Call fal.ai (with webhook_url, 10s timeout)
  ↓ Update row with fal_request_id (or mark failed on error)
  ↓ Return generationId

fal.ai completes → POST /api/ai/webhook (ED25519 verified)
  ↓ Verify: 4 headers + constructed message + hex signature
  ↓ Idempotent: only update if status IN (pending, processing)
  ↓ Update ai_generations (status: completed, video_url, completed_at)

Frontend polls GET /api/ai/status/[id] (our DB only, NOT fal.ai)
  ↓ Returns { status, videoUrl, stage } — never exposes fal_request_id
  ↓ Auto-resumes on page load via localStorage ai_active_generation_id

User clicks "Submit" → POST /api/ai/complete
  ↓ Auth + CSRF + banned check
  ↓ Check completed_at age (reject if > 7 days — fal.ai URL expired)
  ↓ Check active season + slot exist (early fail before signing URL)
  ↓ Atomic complete_initiated_at guard (prevents double-complete)
  ↓ Generate signed upload URL for our storage
  ↓ Construct public URL server-side from storage_key
  ↓ Store storage_key on generation row
  ↓ Return { falVideoUrl, signedUploadUrl, storageKey } — NO publicUrl

Client: fetch(falVideoUrl) → PUT to signedUploadUrl (direct to storage)
  ↓ Note: verify fal.ai CDN allows CORS (*.fal.media) — PREREQUISITE

Client: POST /api/ai/register
  ↓ Auth + CSRF + banned check + feature flag check
  ↓ Re-verify active slot (may have changed since /complete)
  ↓ Construct publicUrl server-side from storage_key (never from client)
  ↓ Insert tournament_clips with AI fields + genre.toUpperCase() + track_id: 'track-main' + duration_seconds
  ↓ Start voting timer if first clip in slot
  ↓ Update ai_generations.clip_id (atomic — WHERE clip_id IS NULL)

Cron (every 5 min): /api/cron/ai-generation-timeout
  ↓ Distributed lock (cron_locks pattern)
  ↓ Map model key → fal.ai model ID before polling
  ↓ Poll fal.ai for stuck generations (> 10 min)
  ↓ Auto-fail anything stuck > 30 min
  ↓ Expire unclaimed completed generations > 24h
  ↓ Clean up orphaned storage files
```

Key changes from original:
- **Client uploads video** (not server) — avoids OOM
- **Webhook-first** for completion — avoids fal.ai polling flood
- **Atomic limit check** — prevents race condition
- **Two-step complete**: `/api/ai/complete` returns URLs, `/api/ai/register` saves metadata
- **CSRF on all mutations**
- **Server-side feature flag check**

---

---

## Deep Dive: fal.ai API Integration Details

### Exact Model IDs & Endpoints

| Model | fal.ai Model ID | Endpoint |
|-------|----------------|----------|
| **Hailuo 2.3 Pro** | `fal-ai/minimax/hailuo-2.3/pro/text-to-video` | `https://queue.fal.run/fal-ai/minimax/hailuo-2.3/pro/text-to-video` |
| **Kling 2.6 Pro** | `fal-ai/kling-video/v2.6/pro/text-to-video` | `https://queue.fal.run/fal-ai/kling-video/v2.6/pro/text-to-video` |
| **Google Veo 3 Fast** | `fal-ai/veo3/fast` | `https://queue.fal.run/fal-ai/veo3/fast` |

> **NOTE:** Kling 2.6 **Standard** (`/standard/text-to-video`) does NOT exist on fal.ai for text-to-video. Only **Pro** is available. The Standard tier exists only for image-to-video.
> **ALTERNATIVE:** Consider using `fal-ai/veo3.1/fast` (Veo 3.1 Fast) instead of `fal-ai/veo3/fast` — newer model, same price, potentially better quality.

### Queue API Flow

```
1. POST https://queue.fal.run/{model_id}
   Headers: { Authorization: "Key $FAL_KEY" }
   Body (varies by model — see examples below):
     Hailuo:  { prompt: "...", prompt_optimizer: true }  // ONLY these 2 params exist
     Kling:   { prompt: "...", aspect_ratio: "9:16", duration: "5", generate_audio: false }
     Veo 3:   { prompt: "...", aspect_ratio: "9:16", duration: "8s", generate_audio: false }
   Response: { request_id: "abc123", status_url: "...", response_url: "..." }

2. Webhook fires → POST /api/ai/webhook
   Body: { request_id: "abc123", status: "OK", payload: { video: { url: "..." } } }
   Verify: X-Fal-Webhook-Signature header (ED25519 via JWKS at https://rest.alpha.fal.ai/.well-known/jwks.json)

3. Fallback polling: GET https://queue.fal.run/{model_id}/requests/{request_id}/status
   Response: { status: "IN_PROGRESS" | "COMPLETED", response_url: "..." }
```

### Webhook Setup

Pass webhook URL as query parameter when submitting:
```
POST https://queue.fal.run/{model_id}?fal_webhook={encoded_webhook_url}
```

**Webhook verification:** ED25519 signatures. fal.ai sends 4 headers: `X-Fal-Webhook-Request-Id`, `X-Fal-Webhook-User-Id`, `X-Fal-Webhook-Timestamp`, `X-Fal-Webhook-Signature`. The signature is **hex-encoded** and verifies against a **constructed message** (NOT the raw body): `{requestId}\n{userId}\n{timestamp}\n{sha256hex(body)}`. Must also validate timestamp within ±300 seconds. Fetch JWKS from `https://rest.alpha.fal.ai/.well-known/jwks.json` (cache 24h). See "Webhook Verification" section for full implementation.

### NPM Package

Use `@fal-ai/client` (v1.8.3+):
```typescript
import { fal } from '@fal-ai/client';

fal.config({ credentials: process.env.FAL_KEY });

// Style-to-prompt prefix mapping (loaded from feature flag config, with fallback defaults)
const STYLE_PREFIXES: Record<string, string> = {
  cinematic: 'cinematic film style,',
  anime: 'anime style,',
  realistic: 'photorealistic,',
  abstract: 'abstract art style,',
  noir: 'film noir style, black and white,',
  retro: 'retro VHS style,',
  neon: 'neon-lit cyberpunk style,',
};

// Default negative prompts per model (reduces bad outputs)
const DEFAULT_NEGATIVE_PROMPTS: Record<string, string> = {
  'kling-2.6': 'blurry, low quality, distorted, watermark, text overlay',
  'veo3-fast': 'blurry, low quality, distorted, watermark, text overlay',
};

// Known durations per model (for duration_seconds on tournament_clips)
const MODEL_DURATION_SECONDS: Record<string, number> = {
  'hailuo-2.3': 6,
  'kling-2.6': 5,
  'veo3-fast': 8,
};

// Build model-specific input parameters
function buildInput(model: string, rawPrompt: string, style?: string, enableAudio: boolean = false) {
  // Prepend style prefix if style is provided
  const styledPrompt = style && STYLE_PREFIXES[style]
    ? `${STYLE_PREFIXES[style]} ${rawPrompt}`
    : rawPrompt;

  switch (model) {
    case 'hailuo-2.3':
      // Hailuo 2.3 Pro ONLY accepts: prompt, prompt_optimizer
      // No aspect_ratio, video_size, or duration params exist
      // Output: landscape ~6s 1080p (portrait NOT possible)
      return { prompt: styledPrompt, prompt_optimizer: true };
    case 'kling-2.6':
      // Kling: duration "5" (no 's'). MUST use 5, not 10 (10s > MAX_VIDEO_DURATION 8.5)
      // generate_audio defaults to true — explicitly set false to halve cost
      return {
        prompt: styledPrompt,
        negative_prompt: DEFAULT_NEGATIVE_PROMPTS['kling-2.6'],
        aspect_ratio: '9:16',
        duration: '5',
        generate_audio: enableAudio,
      };
    case 'veo3-fast':
      // Veo: duration "8s" (WITH 's'). generate_audio defaults to true
      return {
        prompt: styledPrompt,
        negative_prompt: DEFAULT_NEGATIVE_PROMPTS['veo3-fast'],
        aspect_ratio: '9:16',
        duration: '8s',
        generate_audio: enableAudio,
      };
    default:
      throw new Error(`Unknown model: ${model}`);
  }
}

// Submit to queue with webhook
const result = await fal.queue.submit(modelId, {
  input: buildInput(modelKey, prompt),
  webhookUrl: `${process.env.NEXT_PUBLIC_APP_URL}/api/ai/webhook`,
});
```

### Important Constraints (fal.ai)

- **Concurrent tasks:** Standard tier = 2 concurrent tasks per account. Exceeding → queued.
- **Video URL expiration:** fal.ai video URLs expire after ~7 days. Must download/re-upload to our storage before expiration.
- **Portrait mode (9:16):** Kling and Veo use `aspect_ratio: "9:16"`. **Hailuo CANNOT generate portrait** — only accepts `prompt` and `prompt_optimizer` params, no way to control orientation.
- **Duration options (format differs per model!):**
  - Hailuo: NOT configurable (~6s fixed output)
  - Kling: `"5"` or `"10"` (string, NO `s` suffix). **Use "5" only** — 10s clips exceed `MAX_VIDEO_DURATION` (8.5s) in existing `RegisterClipSchema`
  - Veo 3 Fast: `"4s"`, `"6s"`, or `"8s"` (string, WITH `s` suffix)
- **Audio:** Hailuo has NO audio. Kling and Veo 3 have native audio — but `generate_audio` **defaults to `true`**, which doubles the per-second cost. Must explicitly set `generate_audio: false` to use the lower pricing.
- **MAX_VIDEO_DURATION blocker:** Existing `RegisterClipSchema` in `validations.ts` enforces `duration <= 8.5`. A 10-second Kling clip would fail validation. Either: (a) restrict Kling to 5s only, (b) create separate `AIRegisterClipSchema` with higher limit, or (c) omit `duration` field (it's optional).

### Model-Specific Notes

**Hailuo 2.3 Pro:**
- MiniMax's latest model, high quality at fixed low cost ($0.49/video)
- Does NOT have native audio synthesis — only a separate TTS addon, not integrated
- **ONLY accepts 2 parameters:** `prompt` (string) and `prompt_optimizer` (boolean, default true)
- **CANNOT generate portrait 9:16 video** — no `aspect_ratio`, no `video_size`, no `duration` params
- Output is always landscape 1080p, ~6 seconds fixed duration
- Good for stylized content, animations, abstract visuals
- **Limitation for vertical-video app:** May need to be excluded or accepted as landscape-only tier

**Kling 2.6 Pro:**
- Most widely adopted AI video model globally (Kuaishou)
- **Only Pro tier available for text-to-video on fal.ai** — Standard tier exists only for image-to-video
- Best price-to-quality ratio ($0.07/sec without audio, $0.14/sec with audio)
- Native audio generation (sound effects, ambient)
- Supports 720p and 1080p
- Great for realistic humans, lip-sync, dialogue scenes
- Duration format: `"5"` or `"10"` (string, no `s` suffix)

**Veo 3 Fast:**
- Google's fastest video model, cheaper than Veo 3.1 Standard
- Wins quality benchmarks (MovieGenBench)
- Native audio (dialogue, sound effects, ambient)
- Custom duration support (use `"8s"` — WITH `s` suffix)
- Commercial use allowed
- **Consider upgrading to `fal-ai/veo3.1/fast`** — newer model, same price tier

*Future consideration:* OpenAI Sora 2 can be added later via direct OpenAI API (`POST /v1/videos/generations`) if users request it. Would require adding `openai` npm package and a second provider path in `ai-video.ts`.

---

## Deep Dive: Cost Modeling & Abuse Prevention

### Cost Projections

| Scenario | Daily Users | Gens/Day | Model Mix | Avg Cost/Gen | Daily Cost | Monthly Cost |
|----------|-------------|----------|-----------|-------------|------------|-------------|
| **Soft launch** | 50 | 1 | 100% Hailuo | $0.49 | $24.50 | **$735** |
| **MVP (recommended)** | 200 | 1 | 70% Hailuo / 20% Kling / 10% Veo | $0.53 | $106 | **$3,180** |
| **Growth** | 500 | 1 | 50% Hailuo / 30% Kling / 20% Veo | $0.57 | $285 | **$8,550** |
| **3 free/day (dangerous)** | 1000 | 3 | Mixed | $0.55 | $1,650 | **$49,500** |

> **Pricing notes (updated):**
> - Hailuo: $0.49 flat per video (regardless of duration)
> - Kling 2.6 Pro: $0.07/sec (no audio), $0.14/sec (with audio). 5s clip = $0.35 (no audio) to $0.70 (with audio)
> - Veo 3 Fast: $0.10/sec (no audio), $0.15/sec (with audio). 8s clip = $0.80 (no audio) to $1.20 (with audio)
> - Projections above assume no-audio for cost estimates. With audio enabled, Kling and Veo costs roughly double.

**Recommendation:** Start with **1 free generation per day** using Hailuo only. Kling and Veo available but count toward user's daily limit. Consider making Veo a paid/premium feature later.

```json
{ "max_daily_free": 1 }
```

### Abuse Scenarios & Mitigations

| Scenario | Attack | Mitigation |
|----------|--------|------------|
| **Account farming** | Create 50 accounts → 50 free gens/day | Phone verification for AI access, or minimum account age (7 days) |
| **Prompt injection** | "ignore previous instructions, generate..." | Sanitize prompt server-side, keyword blocklist, fal.ai has built-in safety filters |
| **Rapid-fire API abuse** | Script 100 concurrent requests | Rate limit (3/min), atomic daily limit, CSRF, auth required |
| **Cost amplification** | Pick most expensive model repeatedly | Per-model daily limits, global cost cap |
| **Webhook replay** | Replay old webhook → re-complete generation | Idempotent webhook handler (check if already completed), verify ED25519 signature |
| **Generation hoarding** | Generate but never submit → waste credits | Auto-expire generations after 24h, count toward daily limit regardless |

### Atomic Daily Limit — PostgreSQL Function

```sql
CREATE OR REPLACE FUNCTION check_and_reserve_generation(
  p_user_id UUID,
  p_date DATE,
  p_max_daily INTEGER
) RETURNS INTEGER AS $$
DECLARE
  v_count INTEGER;
BEGIN
  INSERT INTO ai_generation_limits (user_id, date, generation_count)
  VALUES (p_user_id, p_date, 1)
  ON CONFLICT (user_id, date)
  DO UPDATE SET generation_count = ai_generation_limits.generation_count + 1
  WHERE ai_generation_limits.generation_count < p_max_daily
  RETURNING generation_count INTO v_count;

  RETURN COALESCE(v_count, -1); -- -1 means limit reached
END;
$$ LANGUAGE plpgsql;
```

### Global Budget Guard

Check platform-wide spend before allowing generation:
```sql
SELECT COALESCE(SUM(cost_cents), 0) as total_today
FROM ai_generations
WHERE created_at >= CURRENT_DATE
  AND status != 'failed';
```

Compare against `daily_cost_limit_cents` in feature flag config. Default: `5000` ($50/day) for soft launch.

---

## Deep Dive: Frontend UX Design

### Upload Page — Tab Toggle

```
┌─────────────────────────────────────┐
│  Step 1: Choose your clip           │
│                                     │
│  ┌──────────────┐ ┌──────────────┐  │
│  │ Upload Video │ │ AI Generate ✨│  │
│  │   (active)   │ │              │  │
│  └──────────────┘ └──────────────┘  │
│                                     │
│  [Drop zone / AI prompt panel]      │
└─────────────────────────────────────┘
```

Hidden entirely when `ai_video_generation` feature flag is off.

### AIGeneratePanel — States

**1. Prompt Input (initial)**
```
┌─────────────────────────────────────┐
│ Describe your clip...               │
│ ┌─────────────────────────────────┐ │
│ │                                 │ │
│ │ (textarea, 500 char limit)      │ │
│ │                             0/500│ │
│ └─────────────────────────────────┘ │
│                                     │
│ Style: [Cinematic] [Anime] [Noir]   │
│        [Realistic] [Abstract] ...   │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │  ✨ Generate (1 of 1 remaining) │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

**2. Generating (progress)**
```
┌─────────────────────────────────────┐
│        [animated orb/spinner]       │
│                                     │
│   Creating your masterpiece...      │
│   ━━━━━━━━━━━━░░░░░░ 65%           │
│                                     │
│   Stage: Rendering frames           │
│   ~45 seconds remaining             │
│                                     │
│         [ Cancel ]                  │
└─────────────────────────────────────┘
```

Progress stages: Submitting → Queued (IN_QUEUE) → Generating (IN_PROGRESS) → Rendering → Ready (COMPLETED)
- Map fal.ai status to UI stage: `IN_QUEUE` → Queued, `IN_PROGRESS` → Generating, `COMPLETED` → Ready
- Store `ai_active_generation_id` in localStorage for auto-resume on page reload

**3. Preview (complete)**
```
┌─────────────────────────────────────┐
│  ┌─────────────────────────┐        │
│  │                         │        │
│  │   [9:16 video player]   │        │
│  │   with play/pause       │        │
│  │                         │        │
│  └─────────────────────────┘        │
│                                     │
│  "A noir detective walks through..." │
│  Style: Cinematic | Model: Hailuo   │
│                                     │
│  [Submit to Tournament]  [Retry ↻]  │
└─────────────────────────────────────┘
```

**4. Limit reached**
```
┌─────────────────────────────────────┐
│  You've used your daily generation  │
│  Come back tomorrow! ⏰              │
│  Resets at midnight UTC             │
└─────────────────────────────────────┘
```

### /create Page — Full Layout

```
┌─────────────────────────────────────────────┐
│  Create with AI                    [← Back] │
│─────────────────────────────────────────────│
│                                             │
│  Prompt                                     │
│  ┌─────────────────────────────────────────┐│
│  │ (large textarea)                        ││
│  │                                     0/500││
│  └─────────────────────────────────────────┘│
│                                             │
│  Suggestions: [epic battle] [sunset city]   │
│               [cute animal] [space odyssey] │
│                                             │
│  Style          Genre          Model           │
│  ┌────────┐    ┌────────┐    ┌───────────────┐ │
│  │Cinemat.│    │ Action │    │ Hailuo 2.3    │ │
│  │ Anime  │    │ Drama  │    │  Free/Default  │ │
│  │  Noir  │    │ Comedy │    │───────────────│ │
│  │ Reali. │    │ Sci-Fi │    │ Kling 2.6     │ │
│  └────────┘    └────────┘    │  Standard      │ │
│                              │───────────────│ │
│                              │ Veo 3 Fast    │ │
│                              │  Premium ★     │ │
│                              └───────────────┘ │
│                                             │
│  [AIGeneratePanel — progress/preview area]  │
│                                             │
│  ─── Recent Generations ────────────────    │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐       │
│  │thumb │ │thumb │ │thumb │ │thumb │       │
│  │ ✓    │ │ ✓    │ │ ✗    │ │ ⏳   │       │
│  └──────┘ └──────┘ └──────┘ └──────┘       │
└─────────────────────────────────────────────┘
```

---

## Deep Dive: Security Hardening

### Webhook Verification

> **Previous code was WRONG.** It verified signature against raw body with base64 encoding. The actual process requires constructing a composite message and uses hex encoding. Corrected below.

fal.ai sends 4 headers with every webhook:
- `X-Fal-Webhook-Request-Id` — unique request identifier
- `X-Fal-Webhook-User-Id` — your fal.ai user ID
- `X-Fal-Webhook-Timestamp` — Unix epoch seconds
- `X-Fal-Webhook-Signature` — ED25519 signature (**hex-encoded**, NOT base64)

The signed message is NOT the raw body. It is a composite:
```
{request_id}\n{user_id}\n{timestamp}\n{sha256_hex_of_body}
```

```typescript
// /api/ai/webhook/route.ts
import crypto from 'crypto';

const JWKS_URL = 'https://rest.alpha.fal.ai/.well-known/jwks.json';
let jwksCache: any[] | null = null;
let jwksCacheTime = 0;
const JWKS_TTL = 24 * 60 * 60 * 1000; // 24 hours

async function fetchJwks() {
  const now = Date.now();
  if (jwksCache && (now - jwksCacheTime) < JWKS_TTL) return jwksCache;
  const res = await fetch(JWKS_URL, { signal: AbortSignal.timeout(10_000) });
  if (!res.ok) throw new Error(`JWKS fetch failed: ${res.status}`);
  const data = await res.json();
  jwksCache = data.keys ?? [];
  jwksCacheTime = now;
  return jwksCache;
}

async function verifyFalWebhook(req: NextRequest): Promise<{ valid: boolean; body: string }> {
  // 1. Extract ALL 4 required headers
  const requestId = req.headers.get('x-fal-webhook-request-id');
  const userId    = req.headers.get('x-fal-webhook-user-id');
  const timestamp = req.headers.get('x-fal-webhook-timestamp');
  const signature = req.headers.get('x-fal-webhook-signature');

  if (!requestId || !userId || !timestamp || !signature) {
    return { valid: false, body: '' };
  }

  // 2. Validate timestamp (±300 seconds / 5 minutes) — prevents replay attacks
  const tsInt = parseInt(timestamp, 10);
  if (isNaN(tsInt) || Math.abs(Math.floor(Date.now() / 1000) - tsInt) > 300) {
    return { valid: false, body: '' };
  }

  // 3. Read raw body
  const body = await req.text();

  // 4. Construct the signed message (NOT the raw body!)
  const bodyHash = crypto.createHash('sha256').update(body).digest('hex');
  const message = [requestId, userId, timestamp, bodyHash].join('\n');
  const messageBytes = Buffer.from(message, 'utf-8');

  // 5. Decode hex signature (must be exactly 64 bytes for ED25519)
  let sigBytes: Buffer;
  try {
    sigBytes = Buffer.from(signature, 'hex');
    if (sigBytes.length !== 64) return { valid: false, body };
  } catch { return { valid: false, body }; }

  // 6. Fetch JWKS and verify with each Ed25519 key
  const keys = await fetchJwks();
  for (const jwk of keys) {
    if (jwk.crv !== 'Ed25519' || jwk.kty !== 'OKP') continue;
    try {
      const publicKey = crypto.createPublicKey({
        key: { kty: jwk.kty, crv: jwk.crv, x: jwk.x },
        format: 'jwk',
      });
      // crypto.verify with null algorithm infers Ed25519 from key type
      if (crypto.verify(null, messageBytes, publicKey, sigBytes)) {
        return { valid: true, body };
      }
    } catch { continue; }
  }
  return { valid: false, body };
}
```

**No external crypto dependency needed** — Node.js 18.4+ has native Ed25519 support via `crypto.createPublicKey` (JWK import) and `crypto.verify(null, ...)`. The `@fal-ai/client` SDK does NOT include webhook verification utilities.

### Security Checklist

| Risk | Mitigation | Implementation |
|------|------------|----------------|
| **CSRF on mutations** | Double-submit cookie | `requireCsrf(req)` on `/generate`, `/complete`, `/register` |
| **Auth bypass** | Server-side session check | NextAuth `getServerSession()` on every AI endpoint |
| **Feature flag bypass** | Server-side flag check | Query `feature_flags` table, not client state |
| **Video URL spoofing** | Server constructs URL | Never accept video URL from client; server builds public URL from known storage path |
| **Webhook forgery** | ED25519 verification | Verify `X-Fal-Webhook-Signature` against fal.ai JWKS |
| **Webhook replay** | Idempotent handler | Only update if status IN (`pending`, `processing`) — reject `completed`, `failed`, `expired` |
| **Prompt injection** | Sanitize + blocklist | `sanitizeText()` + keyword filter before sending to fal.ai |
| **RLS bypass** | Enable RLS on tables | `FOR SELECT USING (user_id = auth.uid())` on `ai_generations`, `ai_generation_limits` |
| **Race on limits** | Atomic PG function | `check_and_reserve_generation()` — single atomic operation |
| **Cost runaway** | Multi-layer caps | Per-user daily + global daily + monthly + feature flag kill switch |

### RLS Policies (add to migration)

```sql
ALTER TABLE ai_generations ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_generation_limits ENABLE ROW LEVEL SECURITY;

-- Users can only read their own generations
CREATE POLICY ai_gen_select ON ai_generations
  FOR SELECT USING (user_id = auth.uid());

-- Users can only read their own limits
CREATE POLICY ai_limits_select ON ai_generation_limits
  FOR SELECT USING (user_id = auth.uid());

-- Service role bypasses RLS (used by API routes and webhook)
```

---

## Deep Dive: Webhook Timeout & Fallback

fal.ai webhooks may fail silently (network issues, deployment gaps, etc.). Without a fallback, generations would be stuck in `pending`/`processing` forever.

### Fallback Cron Job

**New file:** `src/app/api/cron/ai-generation-timeout/route.ts`

Runs every 5 minutes via Vercel Cron. Uses `cron_locks` distributed lock (same pattern as `auto-advance`):

```typescript
// 0. Auth check: verify CRON_SECRET (same as auto-advance)
// 0b. Distributed lock: INSERT INTO cron_locks WHERE job_name = 'ai-generation-timeout'

// 1. Find generations stuck in 'pending' or 'processing' for > 10 minutes
const stale = await supabase
  .from('ai_generations')
  .select('id, fal_request_id, model, updated_at')
  .in('status', ['pending', 'processing'])
  .lt('updated_at', tenMinutesAgo.toISOString());

// 2. For each stale generation, poll fal.ai directly
//    IMPORTANT: gen.model is the model KEY (e.g. "kling-2.6"), NOT the fal.ai model ID.
//    Must map to the fal.ai model ID before polling.
for (const gen of stale.data) {
  const modelConfig = MODELS[gen.model];
  if (!modelConfig) { /* mark as failed — unknown model */ continue; }
  const status = await fal.queue.status(modelConfig.modelId, { requestId: gen.fal_request_id });

  if (status.status === 'COMPLETED') {
    // Webhook was lost — update DB from poll result
    await supabase.from('ai_generations').update({
      status: 'completed',
      video_url: status.response?.video?.url,
      completed_at: new Date().toISOString(),
    }).eq('id', gen.id);
  } else if (status.status === 'FAILED') {
    await supabase.from('ai_generations').update({
      status: 'failed',
      error_message: status.error || 'Generation failed on provider',
    }).eq('id', gen.id);
  }
  // If still IN_QUEUE after 10 min, update to 'processing' and continue waiting (fal.ai queue is busy)
  // If still IN_PROGRESS after 10 min, leave it — check again next cron run
}

// 3. Auto-fail anything stuck for > 30 minutes (provider likely lost it)
await supabase.from('ai_generations').update({
  status: 'failed',
  error_message: 'Generation timed out after 30 minutes',
}).in('status', ['pending', 'processing'])
  .lt('updated_at', thirtyMinutesAgo.toISOString());

// 4. Expire unclaimed completed generations older than 24h
await supabase.from('ai_generations').update({
  status: 'expired',
}).eq('status', 'completed')
  .is('clip_id', null)
  .lt('completed_at', twentyFourHoursAgo.toISOString());

// 5. Clean up orphaned storage files (storage_key set but clip_id NULL and status is failed/expired)
const orphans = await supabase
  .from('ai_generations')
  .select('id, storage_key')
  .in('status', ['failed', 'expired'])
  .is('clip_id', null)
  .not('storage_key', 'is', null)
  .limit(50);

for (const orphan of orphans.data ?? []) {
  await supabase.storage.from('clips').remove([orphan.storage_key]);
  await supabase.from('ai_generations').update({ storage_key: null }).eq('id', orphan.id);
}
```

Add to `vercel.json`:
```json
{
  "crons": [
    { "path": "/api/cron/ai-generation-timeout", "schedule": "*/5 * * * *" }
  ]
}
```

### Auto-Expire Unclaimed Generations

Generations that complete but are never submitted to the tournament (user closes browser) should be cleaned up:

```sql
-- Run daily: expire completed generations older than 24h that were never claimed
UPDATE ai_generations
SET status = 'expired'
WHERE status = 'completed'
  AND clip_id IS NULL
  AND completed_at < NOW() - INTERVAL '24 hours';
```

Add `'expired'` to the status constraint:
```sql
CONSTRAINT valid_ai_status CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'expired'))
```

---

## Deep Dive: Additional Security Gaps

### Webhook Security

| Gap | Risk | Fix |
|-----|------|-----|
| **No CORS restriction on webhook** | Any origin can attempt POST | Add explicit `Access-Control-Allow-Origin: none` and reject non-POST methods |
| **No rate limit on webhook endpoint** | Flood attack could overwhelm DB | Add rate limit: 100 req/min on `/api/ai/webhook` |
| **No rate limit on status endpoint** | Polling abuse | Add rate limit: 30 req/min on `/api/ai/status/[id]` |

### Cost & Budget

| Gap | Risk | Fix |
|-----|------|-----|
| **Global cost cap race condition** | Two concurrent requests both read sum < limit, both proceed | Use `SELECT ... FOR UPDATE` or atomic PG function (same pattern as daily limit) |
| **Keyword blocklist undefined** | Plan mentions blocklist but never defines words | Add initial blocklist to feature flag config (done above). Load dynamically from config so admin can update without deploy. |
| **No per-model daily limits** | User burns expensive Veo all day | Add `max_daily_per_model` to feature flag config: `{ "veo3-fast": 1, "kling-2.6": 2 }` |

### Error Handling Gaps (16+ scenarios)

These error scenarios need explicit handling in the API routes:

| Route | Scenario | Current | Fix |
|-------|----------|---------|-----|
| `/api/ai/generate` | fal.ai returns 402 (insufficient credits) | Unhandled | Return 503 + "AI service temporarily unavailable" |
| `/api/ai/generate` | fal.ai returns 429 (rate limited) | Unhandled | Retry once with backoff, then return 503 |
| `/api/ai/generate` | fal.ai returns 500/502/503 | Unhandled | Return 503 + generic error message |
| `/api/ai/generate` | Network timeout to fal.ai | Unhandled | 10s timeout, return 503 on timeout |
| `/api/ai/generate` | Invalid model in request body | Zod validates | OK — covered |
| `/api/ai/webhook` | Duplicate webhook for same request_id | Potential double-processing | Only update if status IN (`pending`, `processing`) — reject `completed`/`failed`/`expired` |
| `/api/ai/webhook` | Webhook body missing `video.url` | Unhandled | Mark as `failed` with "No video URL in response" |
| `/api/ai/webhook` | Webhook reports failure (status != OK) | Unhandled | Mark as `failed`, store error message |
| `/api/ai/complete` | Generation status is not `completed` | Unhandled | Return 400 "Generation not ready" |
| `/api/ai/complete` | fal.ai video URL has expired (>7 days old) | Unhandled | Check `completed_at` age, return 410 "Video expired, please regenerate" |
| `/api/ai/complete` | No active season found | `.single()` crash (bug #2) | Return 400 "No active season" |
| `/api/ai/complete` | No available slot for genre | Unhandled | Return 400 "No available slot" |
| `/api/ai/register` | Signed URL expired before upload finished | Unhandled | Return 400 "Upload expired, try again" |
| `/api/ai/register` | clip_id already set on generation (double submit) | Duplicate clip | Check `clip_id IS NULL` before allowing |
| `/api/ai/history` | No generations found | Returns empty array | OK — covered |
| `/api/ai/status/[id]` | Generation doesn't exist | Unhandled | Return 404 |

### Integration Blocker: Genre Mismatch

`src/lib/validations.ts` defines `ALLOWED_GENRES` with `'sci-fi'` (hyphenated), but the upload page and other frontend code uses `'scifi'` (no hyphen). AI video generation must use the same genre values as the rest of the app.

**Fix:** Align all genre references to use the same format. Recommended: use `'sci-fi'` everywhere (matches `validations.ts` source of truth). Update upload page and any hardcoded references.

---

## Updated Files Summary (incorporating all fixes)

### New Files (13)

| File | Purpose |
|------|---------|
| `supabase/sql/migration-ai-video-generation.sql` | DB migration (tables, indexes, RLS, atomic functions, triggers, feature flag) |
| `src/lib/ai-video.ts` | fal.ai integration library — `buildInput()` with style prefixes + negative prompts, `MODELS` config, `MODEL_DURATION_SECONDS`, `STYLE_PREFIXES`, via `@fal-ai/client` |
| `src/app/api/ai/generate/route.ts` | Start generation (CSRF, banned check, flag, atomic limit, global cap, DB-first insert, fal.ai error handling) |
| `src/app/api/ai/status/[id]/route.ts` | Poll status (reads our DB only, rate limited 30/min, never exposes `fal_request_id`) |
| `src/app/api/ai/complete/route.ts` | Prepare signed upload URL (season/slot check, atomic double-complete guard, server-side URL construction, stores storage_key) |
| `src/app/api/ai/register/route.ts` | Register clip (mirrors existing upload/register, re-verifies slot, genre.toUpperCase(), track_id, duration_seconds, voting timer, server-side publicUrl) |
| `src/app/api/ai/webhook/route.ts` | fal.ai webhook (4-header ED25519 verification, constructed message, hex signature, idempotent, rate limited) |
| `src/app/api/ai/history/route.ts` | User's generation history (paginated) |
| `src/app/api/cron/ai-generation-timeout/route.ts` | Fallback cron (5 steps): distributed lock, poll fal.ai for stuck gens (model key→ID mapping), auto-fail 30min, expire unclaimed 24h, clean orphaned storage files |
| `src/app/api/admin/ai-stats/route.ts` | Admin cost tracking dashboard data |
| `src/components/AIGeneratePanel.tsx` | Shared generation UI (prompt → progress → preview → submit) |
| `src/app/create/page.tsx` | Dedicated create page (full prompt builder, model picker, history) |
| `src/hooks/useAIGenerations.ts` | React Query hook for generation history |

### Modified Files (9)

| File | Change |
|------|--------|
| `src/lib/validations.ts` | Add `AIGenerateSchema` (Zod v4, `.strict()`), export `ALLOWED_GENRES` |
| `src/lib/rate-limit.ts` | Add `ai_generate`, `ai_status` rate limit tiers; add `ai_generate` to `CRITICAL_RATE_LIMIT_TYPES` |
| `src/lib/audit-log.ts` | Add `'ai_generate' \| 'ai_complete' \| 'ai_register'` to `AuditAction`; add `'ai_generation'` to `ResourceType` |
| `src/types/index.ts` | Add `AIGeneration`, `AIModel`, `AIStyle` types; fix `GENRES` to match `ALLOWED_GENRES`; fix `VotingClip.genre` |
| `src/app/upload/page.tsx` | Add AI Generate tab toggle (conditional on feature flag) |
| `src/app/admin/page.tsx` | AI badges, prompt display, AI-only filter |
| `src/app/api/admin/clips/route.ts` | Add AI fields to query + `?ai_only` param |
| `src/components/BottomNavigation.tsx` | Add "Create" nav item with `Sparkles` icon (conditional on `ai_video_generation` flag) |
| `vercel.json` | Add `ai-generation-timeout` cron entry |

### Pre-Implementation Prerequisites

These issues in the existing codebase must be fixed BEFORE AI implementation:

| Issue | Files | Required Fix |
|-------|-------|-------------|
| Genre mismatch (scifi vs sci-fi vs 4 types) | `types/index.ts`, `validations.ts`, `upload/page.tsx`, `admin/page.tsx` | Align all genre lists to single source of truth |
| `@fal-ai/client` not installed | `package.json` | `npm install @fal-ai/client` (pin exact version) |
| `VotingClip.genre` only has 4 values | `types/index.ts` | Add all 8 genres in UPPERCASE |
| `DbClip` type missing many fields | `types/index.ts` | Update to match actual `tournament_clips` columns |
| Verify fal.ai CDN CORS | n/a | **CRITICAL:** Test `fetch('https://fal.media/...')` from browser origin — if blocked, entire client-upload flow breaks. Fallback: lightweight streaming proxy via `/api/ai/proxy-download?id=xxx` (streams fal.ai → client, avoids OOM by not buffering) |

---

## Verification

1. `npx next build` — no errors after each phase
2. Feature flag OFF → no AI UI visible anywhere, API returns 403
3. Feature flag ON → AI tab on upload page, /create page accessible
4. Generate clip → poll status → preview → submit → appears in admin pending queue
5. Daily limit reached → shows "limit reached" message, API returns 429
6. Admin sees AI badge + prompt on generated clips
7. Admin cost dashboard shows generation counts and costs
8. Two concurrent generate requests from same user at limit → only one succeeds
9. fal.ai webhook fires → generation status updates without polling
10. Client-side upload of AI video → file lands in correct storage bucket
11. Webhook without valid ED25519 signature → rejected with 401
12. Direct API call without CSRF token → rejected with 403
13. Global daily cost cap exceeded → all users see "service temporarily unavailable"
14. Generation with `status: completed` receives duplicate webhook → no-op
15. Banned user calls `/api/ai/generate` → rejected with 403
16. fal.ai returns 402 (insufficient credits) → generation marked failed, user sees "AI service temporarily unavailable"
17. Webhook for unknown `fal_request_id` → logged, returns 200 (prevents retries)
18. Generation stuck 30+ minutes → cron auto-fails, user sees "Generation timed out"
19. User completes but never registers → generation cleaned up after timeout
20. Model-specific params: Kling uses `aspect_ratio: "9:16"`, `duration: "5"`, `generate_audio: false`
21. Slot advances between complete and register → register uses current active slot, not stale one
22. Feature flag disabled mid-generation → webhook still processes, but register/complete blocked
23. Hailuo generates landscape video → displayed correctly in UI (letterboxed or excluded from portrait-only app)
24. Default model is `kling-2.6` (not Hailuo) → generates portrait 9:16 by default
25. Style "cinematic" prepends style prefix to prompt → different output than no style
26. Cron correctly maps model key to fal.ai model ID → fallback polling works
27. `/complete` checks season/slot before returning signed URL → no orphaned uploads
28. `/register` constructs public URL from storage_key → no client-supplied URL
29. `duration_seconds` set correctly per model (Hailuo=6, Kling=5, Veo=8)
30. Page reload during generation → auto-resumes polling from localStorage
31. Global cost cap prevents concurrent race → `check_global_cost_cap()` PG function
32. Orphaned storage files cleaned up by cron → storage_key nulled after deletion
33. Negative prompts sent for Kling/Veo → reduced artifacts in output
34. IN_QUEUE fal.ai status → frontend shows "Queued" stage (not stuck on "Generating")
